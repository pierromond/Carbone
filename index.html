<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>‚öñÔ∏è Dilemmes Carbone</title>
<meta property="og:title" content="Dilemmes Carbone ‚Äî Quel CO‚ÇÇ choisir ?">
<meta property="og:description" content="Chaque geste a un co√ªt climatique. Votez pour hi√©rarchiser vos priorit√©s dans ces dilemmes √©thiques calibr√©s ADEME.">
<meta property="og:type" content="website">
<meta property="og:url" content="https://pierromond.github.io/Carbone/">
<meta name="description" content="Dilemmes carbone : comparez des actions du quotidien et votez. Donn√©es ADEME, votes collectifs en temps r√©el.">
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,700;0,900;1,700&family=DM+Mono:wght@400;500&family=Lora:ital@0;1&display=swap" rel="stylesheet">
<style>
  :root, [data-theme="dark"] {
    --bg: #0e0e0b;
    --surface: #18180f;
    --card: #1e1e13;
    --border: #2e2e1e;
    --accent: #c8a84b;
    --accent2: #5d8a45;
    --text: #e8e4d4;
    --muted: #7a7660;
    --danger: #c45c3a;
    --glow: rgba(200, 168, 75, 0.15);
    --grain-opacity: 0.5;
    --card-shadow: rgba(0,0,0,0.4);
  }

  [data-theme="light"] {
    --bg: #f5f2eb;
    --surface: #eae6dd;
    --card: #ffffff;
    --border: #d5d0c4;
    --accent: #9a7d2e;
    --accent2: #3d6e28;
    --text: #2a2820;
    --muted: #8a8578;
    --danger: #b5432a;
    --glow: rgba(154, 125, 46, 0.1);
    --grain-opacity: 0.15;
    --card-shadow: rgba(0,0,0,0.08);
  }

  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'Lora', Georgia, serif;
    min-height: 100vh;
    overflow-x: hidden;
  }

  /* Grain overlay */
  body::before {
    content: '';
    position: fixed;
    inset: 0;
    background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.04'/%3E%3C/svg%3E");
    pointer-events: none;
    z-index: 1000;
    opacity: var(--grain-opacity, 0.5);
  }

  header {
    text-align: center;
    padding: 3rem 2rem 2rem;
    border-bottom: 1px solid var(--border);
    position: relative;
    overflow: hidden;
  }

  header::after {
    content: '';
    position: absolute;
    bottom: -1px;
    left: 50%;
    transform: translateX(-50%);
    width: 120px;
    height: 2px;
    background: var(--accent);
  }

  .header-label {
    font-family: 'DM Mono', monospace;
    font-size: 0.7rem;
    letter-spacing: 0.25em;
    text-transform: uppercase;
    color: var(--accent);
    margin-bottom: 1rem;
  }

  h1 {
    font-family: 'Playfair Display', Georgia, serif;
    font-size: clamp(2rem, 6vw, 4.5rem);
    font-weight: 900;
    line-height: 1.05;
    color: var(--text);
    margin-bottom: 0.75rem;
  }

  h1 em {
    font-style: italic;
    color: var(--accent);
  }

  .subtitle {
    font-size: 1rem;
    color: var(--muted);
    font-style: italic;
    max-width: 560px;
    margin: 0 auto;
    line-height: 1.6;
  }

  .co2-badge {
    display: inline-block;
    margin-top: 1.5rem;
    background: var(--glow);
    border: 1px solid var(--accent);
    border-radius: 2px;
    padding: 0.35rem 0.9rem;
    font-family: 'DM Mono', monospace;
    font-size: 0.75rem;
    letter-spacing: 0.1em;
    color: var(--accent);
  }

  /* Main arena */
  .arena {
    max-width: 960px;
    margin: 0 auto;
    padding: 3rem 1.5rem;
  }

  .question-label {
    font-family: 'DM Mono', monospace;
    font-size: 0.65rem;
    letter-spacing: 0.2em;
    text-transform: uppercase;
    color: var(--muted);
    text-align: center;
    margin-bottom: 2rem;
  }

  .duel {
    display: grid;
    grid-template-columns: 1fr auto 1fr;
    gap: 1.5rem;
    align-items: stretch;
    margin-bottom: 2.5rem;
  }

  .choice-card {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 4px;
    padding: 2.5rem 2rem;
    cursor: pointer;
    transition: all 0.25s ease;
    position: relative;
    overflow: hidden;
    display: flex;
    flex-direction: column;
    align-items: flex-start;
    gap: 1rem;
  }

  .choice-card::before {
    content: '';
    position: absolute;
    inset: 0;
    background: linear-gradient(135deg, var(--glow) 0%, transparent 60%);
    opacity: 0;
    transition: opacity 0.3s ease;
  }

  .choice-card:hover {
    border-color: var(--accent);
    transform: translateY(-3px);
    box-shadow: 0 12px 40px var(--card-shadow), 0 0 0 1px var(--accent);
  }

  .choice-card:hover::before { opacity: 1; }

  .choice-card.winner {
    animation: winner-flash 0.6s ease forwards;
  }
  .choice-card.loser {
    animation: loser-fade 0.6s ease forwards;
  }

  @keyframes winner-flash {
    0% { background: var(--card); }
    40% { background: rgba(93, 138, 69, 0.3); border-color: var(--accent2); }
    100% { background: var(--card); }
  }
  @keyframes loser-fade {
    0% { opacity: 1; }
    100% { opacity: 0.3; }
  }

  .card-letter {
    font-family: 'Playfair Display', serif;
    font-size: 5rem;
    font-weight: 900;
    font-style: italic;
    color: var(--border);
    line-height: 1;
    position: absolute;
    top: 1rem;
    right: 1.5rem;
    transition: color 0.3s;
    user-select: none;
  }

  .choice-card:hover .card-letter { color: rgba(200, 168, 75, 0.2); }

  .card-tag {
    font-family: 'DM Mono', monospace;
    font-size: 0.6rem;
    letter-spacing: 0.2em;
    text-transform: uppercase;
    color: var(--accent);
    background: rgba(200, 168, 75, 0.1);
    padding: 0.2rem 0.5rem;
    border-radius: 2px;
  }

  .card-text {
    font-size: 1.1rem;
    line-height: 1.55;
    color: var(--text);
    position: relative;
    z-index: 1;
    flex: 1;
  }

  .card-co2 {
    font-family: 'DM Mono', monospace;
    font-size: 0.75rem;
    color: var(--muted);
    display: flex;
    align-items: center;
    gap: 0.4rem;
  }

  .card-co2 span {
    color: var(--accent);
    font-weight: 500;
  }

  .card-co2.co2-high span { color: var(--danger); }
  .card-co2.co2-low span { color: var(--accent2); }

  .vs-divider {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    padding: 0 0.5rem;
  }

  .vs-line {
    width: 1px;
    flex: 1;
    background: var(--border);
  }

  .vs-text {
    font-family: 'Playfair Display', serif;
    font-size: 1.4rem;
    font-style: italic;
    color: var(--muted);
    writing-mode: vertical-rl;
    letter-spacing: 0.1em;
  }

  .vote-counter {
    text-align: center;
    font-family: 'DM Mono', monospace;
    font-size: 0.7rem;
    color: var(--muted);
    letter-spacing: 0.1em;
  }

  .vote-counter strong {
    color: var(--accent);
    font-size: 1.1rem;
  }

  .skip-btn {
    display: block;
    margin: 0 auto 3rem;
    background: none;
    border: 1px solid var(--border);
    color: var(--muted);
    font-family: 'DM Mono', monospace;
    font-size: 0.7rem;
    letter-spacing: 0.15em;
    text-transform: uppercase;
    padding: 0.5rem 1.5rem;
    cursor: pointer;
    border-radius: 2px;
    transition: all 0.2s ease;
  }

  .skip-btn:hover { color: var(--text); border-color: var(--muted); }

  /* Leaderboard */
  .leaderboard-section {
    border-top: 1px solid var(--border);
    padding-top: 3rem;
  }

  .section-header {
    display: flex;
    align-items: baseline;
    gap: 1rem;
    margin-bottom: 2rem;
  }

  .section-title {
    font-family: 'Playfair Display', serif;
    font-size: 1.8rem;
    font-weight: 700;
    font-style: italic;
  }

  .section-mono {
    font-family: 'DM Mono', monospace;
    font-size: 0.65rem;
    letter-spacing: 0.2em;
    text-transform: uppercase;
    color: var(--muted);
  }

  .leaderboard {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }

  .rank-item {
    display: grid;
    grid-template-columns: 3rem 1fr auto auto;
    align-items: center;
    gap: 1rem;
    padding: 0.9rem 1rem;
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 3px;
    transition: all 0.4s ease;
    position: relative;
    overflow: hidden;
  }

  .rank-item.top-3 {
    border-color: rgba(200, 168, 75, 0.4);
  }

  .rank-item.top-3::before {
    content: '';
    position: absolute;
    left: 0;
    top: 0;
    bottom: 0;
    width: 3px;
    background: var(--accent);
  }

  .rank-num {
    font-family: 'DM Mono', monospace;
    font-size: 0.8rem;
    color: var(--muted);
    text-align: center;
  }

  .rank-item.top-3 .rank-num {
    color: var(--accent);
    font-weight: 500;
  }

  .rank-text {
    font-size: 0.9rem;
    line-height: 1.4;
    color: var(--text);
  }

  .rank-score {
    font-family: 'DM Mono', monospace;
    font-size: 0.75rem;
    color: var(--accent2);
    white-space: nowrap;
  }

  .rank-bar-wrap {
    width: 80px;
    height: 4px;
    background: var(--border);
    border-radius: 2px;
    overflow: hidden;
  }

  .rank-bar {
    height: 100%;
    background: var(--accent);
    border-radius: 2px;
    transition: width 0.6s ease;
  }

  .rank-item.last .rank-bar {
    background: var(--danger);
  }

  .no-votes {
    color: var(--muted);
    font-style: italic;
    font-size: 0.85rem;
  }

  .filter-tabs {
    display: flex;
    gap: 0.5rem;
    margin-bottom: 1.5rem;
    flex-wrap: wrap;
  }

  .tab-btn {
    font-family: 'DM Mono', monospace;
    font-size: 0.65rem;
    letter-spacing: 0.15em;
    text-transform: uppercase;
    padding: 0.35rem 0.9rem;
    border: 1px solid var(--border);
    background: none;
    color: var(--muted);
    border-radius: 2px;
    cursor: pointer;
    transition: all 0.2s;
  }

  .tab-btn.active, .tab-btn:hover {
    background: var(--glow);
    border-color: var(--accent);
    color: var(--accent);
  }

  footer {
    text-align: center;
    padding: 3rem 2rem;
    border-top: 1px solid var(--border);
    margin-top: 4rem;
    font-family: 'DM Mono', monospace;
    font-size: 0.65rem;
    letter-spacing: 0.1em;
    color: var(--muted);
  }

  footer em { color: var(--accent); }

  @media (max-width: 640px) {
    .duel {
      grid-template-columns: 1fr;
      grid-template-rows: 1fr auto 1fr;
    }
    .vs-divider { flex-direction: row; padding: 0; }
    .vs-line { flex: 1; height: 1px; width: auto; }
    .vs-text { writing-mode: horizontal-tb; }
    .rank-bar-wrap { display: none; }
    .rank-item { grid-template-columns: 2.5rem 1fr auto; }
  }

  .db-status {
    display: inline-flex;
    align-items: center;
    gap: 0.4rem;
    margin-top: 0.75rem;
  }

  .live-dot {
    width: 6px;
    height: 6px;
    background: var(--accent2);
    border-radius: 50%;
    animation: pulse-live 2s infinite;
  }

  .live-dot.offline {
    background: var(--danger);
    animation: none;
  }

  @keyframes pulse-live {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.3; }
  }

  /* Mode switcher */
  .mode-switcher {
    position: fixed;
    top: 1rem;
    left: 1rem;
    z-index: 999;
    display: flex;
    flex-direction: column;
    gap: 0.35rem;
  }

  .mode-btn {
    font-family: 'DM Mono', monospace;
    font-size: 0.6rem;
    letter-spacing: 0.1em;
    text-transform: uppercase;
    padding: 0.4rem 0.75rem;
    border: 1px solid var(--border);
    background: var(--surface);
    color: var(--muted);
    border-radius: 3px;
    cursor: pointer;
    transition: all 0.25s ease;
    white-space: nowrap;
    text-align: left;
  }

  .mode-btn:hover {
    border-color: var(--muted);
    color: var(--text);
  }

  .mode-btn.active {
    background: var(--glow);
    border-color: var(--accent);
    color: var(--accent);
    box-shadow: 0 0 12px rgba(200, 168, 75, 0.15);
  }

  .mode-btn .mode-icon {
    margin-right: 0.3rem;
  }

  .mode-indicator {
    font-family: 'DM Mono', monospace;
    font-size: 0.55rem;
    letter-spacing: 0.15em;
    text-transform: uppercase;
    color: var(--muted);
    padding: 0 0.2rem;
  }

  @media (max-width: 640px) {
    .mode-switcher {
      position: relative;
      top: auto;
      left: auto;
      flex-direction: row;
      justify-content: center;
      padding: 0.75rem 1rem 0;
    }
    .theme-toggle {
      position: relative;
      top: auto;
      right: auto;
      margin: 0.5rem auto 0;
      display: block;
    }
  }

  /* Theme toggle */
  .theme-toggle {
    position: fixed;
    top: 1rem;
    right: 1rem;
    z-index: 999;
  }

  /* Duel transition */
  #duel {
    transition: opacity 0.3s ease, transform 0.3s ease;
  }
  #duel.transitioning {
    opacity: 0;
    transform: scale(0.97);
  }

  /* Post-vote info */
  .post-vote-info {
    text-align: center;
    margin: 1rem 0 0.5rem;
    min-height: 2.5rem;
  }
  .equiv-bubble {
    font-family: 'DM Mono', monospace;
    font-size: 0.7rem;
    color: var(--accent);
    opacity: 0;
    transition: opacity 0.4s ease;
    padding: 0.3rem 0.8rem;
    display: inline-block;
    letter-spacing: 0.05em;
  }
  .equiv-bubble.visible { opacity: 1; }
  .streak-msg {
    font-family: 'DM Mono', monospace;
    font-size: 0.7rem;
    color: var(--accent2);
    opacity: 0;
    transition: opacity 0.4s ease;
    margin-top: 0.3rem;
  }
  .streak-msg.visible { opacity: 1; }

  /* ====== WELCOME OVERLAY ====== */
  .welcome-overlay {
    position: fixed;
    inset: 0;
    background: var(--bg);
    z-index: 900;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: opacity 0.7s ease, visibility 0.7s ease;
  }
  .welcome-overlay.hidden {
    opacity: 0;
    visibility: hidden;
    pointer-events: none;
  }
  .welcome-content {
    text-align: center;
    max-width: 580px;
    padding: 2rem;
    animation: welcome-in 1s ease both;
  }
  @keyframes welcome-in {
    from { opacity: 0; transform: translateY(40px); }
    to { opacity: 1; transform: translateY(0); }
  }
  .welcome-label {
    font-family: 'DM Mono', monospace;
    font-size: 0.65rem;
    letter-spacing: 0.35em;
    color: var(--accent);
    margin-bottom: 2rem;
  }
  .welcome-title {
    font-family: 'Playfair Display', Georgia, serif;
    font-size: clamp(2.8rem, 9vw, 5.5rem);
    font-weight: 900;
    line-height: 1.05;
    color: var(--text);
    margin-bottom: 1.5rem;
  }
  .welcome-title em {
    font-style: italic;
    color: var(--accent);
  }
  .welcome-desc {
    font-size: 1.1rem;
    color: var(--muted);
    line-height: 1.75;
    margin-bottom: 2rem;
    font-style: italic;
  }
  .welcome-badges {
    display: flex;
    gap: 0.75rem;
    justify-content: center;
    flex-wrap: wrap;
    margin-bottom: 2.5rem;
  }
  .welcome-badge {
    font-family: 'DM Mono', monospace;
    font-size: 0.7rem;
    letter-spacing: 0.05em;
    color: var(--text);
    background: var(--surface);
    border: 1px solid var(--border);
    padding: 0.45rem 0.9rem;
    border-radius: 3px;
  }
  .welcome-start {
    display: inline-block;
    font-family: 'Playfair Display', serif;
    font-size: 1.15rem;
    font-weight: 700;
    color: var(--bg);
    background: var(--accent);
    border: none;
    padding: 1rem 2.8rem;
    border-radius: 4px;
    cursor: pointer;
    transition: all 0.3s ease;
    letter-spacing: 0.03em;
    position: relative;
    overflow: hidden;
  }
  .welcome-start:hover {
    transform: translateY(-3px);
    box-shadow: 0 10px 40px rgba(200, 168, 75, 0.35);
  }
  .welcome-start::after {
    content: '';
    position: absolute;
    inset: 0;
    background: linear-gradient(135deg, rgba(255,255,255,0.18) 0%, transparent 50%);
  }
  .welcome-count {
    margin-top: 1.8rem;
    font-family: 'DM Mono', monospace;
    font-size: 0.7rem;
    color: var(--muted);
    letter-spacing: 0.05em;
  }
  .welcome-count span { color: var(--accent); font-weight: 500; }
  .welcome-how {
    margin-top: 2.5rem;
    display: flex;
    gap: 1.5rem;
    justify-content: center;
    flex-wrap: wrap;
  }
  .how-step {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.4rem;
    max-width: 140px;
  }
  .how-num {
    width: 28px; height: 28px;
    background: var(--glow);
    border: 1px solid var(--accent);
    border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    font-family: 'DM Mono', monospace;
    font-size: 0.65rem;
    color: var(--accent);
    font-weight: 500;
  }
  .how-text {
    font-size: 0.75rem;
    color: var(--muted);
    line-height: 1.4;
    text-align: center;
  }

  /* ====== PROGRESS BAR ====== */
  .progress-wrap {
    display: flex;
    align-items: center;
    gap: 1rem;
    margin-bottom: 1.5rem;
    opacity: 0;
    transition: opacity 0.5s ease;
  }
  .progress-wrap.visible { opacity: 1; }
  .progress-bar {
    flex: 1;
    height: 4px;
    background: var(--border);
    border-radius: 2px;
    overflow: hidden;
  }
  .progress-fill {
    height: 100%;
    background: linear-gradient(90deg, var(--accent2), var(--accent));
    border-radius: 2px;
    transition: width 0.6s cubic-bezier(0.4, 0, 0.2, 1);
  }
  .progress-text {
    font-family: 'DM Mono', monospace;
    font-size: 0.7rem;
    color: var(--muted);
    white-space: nowrap;
    min-width: 3.5rem;
    text-align: right;
  }
  .progress-dots {
    display: flex;
    gap: 0.5rem;
    justify-content: center;
    margin-bottom: 2rem;
  }
  .progress-dot {
    width: 8px; height: 8px;
    border-radius: 50%;
    background: var(--border);
    transition: all 0.4s ease;
  }
  .progress-dot.done { background: var(--accent); }
  .progress-dot.current {
    background: var(--accent);
    animation: dot-pulse 1.5s ease infinite;
  }
  @keyframes dot-pulse {
    0%, 100% { box-shadow: 0 0 0 0 rgba(200, 168, 75, 0.4); }
    50% { box-shadow: 0 0 0 5px rgba(200, 168, 75, 0); }
  }

  /* ====== RESULTS OVERLAY ====== */
  .results-overlay {
    position: fixed;
    inset: 0;
    background: var(--bg);
    z-index: 800;
    overflow-y: auto;
    opacity: 0;
    visibility: hidden;
    transition: opacity 0.6s ease, visibility 0.6s ease;
  }
  .results-overlay.visible {
    opacity: 1;
    visibility: visible;
  }
  .results-content {
    max-width: 640px;
    margin: 0 auto;
    padding: 3rem 2rem 4rem;
    text-align: center;
    animation: results-slide 0.8s ease both;
  }
  @keyframes results-slide {
    from { opacity: 0; transform: translateY(30px); }
    to { opacity: 1; transform: translateY(0); }
  }
  .results-label {
    font-family: 'DM Mono', monospace;
    font-size: 0.65rem;
    letter-spacing: 0.35em;
    color: var(--accent);
    margin-bottom: 1.5rem;
  }
  .results-title {
    font-family: 'Playfair Display', Georgia, serif;
    font-size: clamp(2rem, 6vw, 3.5rem);
    font-weight: 900;
    line-height: 1.1;
    color: var(--text);
    margin-bottom: 1rem;
  }
  .results-title em { font-style: italic; color: var(--accent); }
  .results-desc {
    color: var(--muted);
    font-style: italic;
    margin-bottom: 2.5rem;
    font-size: 1rem;
    line-height: 1.6;
  }
  .profile-chart {
    text-align: left;
    margin-bottom: 2.5rem;
  }
  /* Persona card */
  .persona-card {
    background: var(--surface);
    border: 1px solid var(--accent);
    border-radius: 6px;
    padding: 2rem 1.5rem;
    margin-bottom: 2rem;
    text-align: center;
  }
  .persona-emoji { font-size: 3rem; margin-bottom: 0.75rem; }
  .persona-name {
    font-family: 'Playfair Display', serif;
    font-size: 1.6rem;
    font-weight: 700;
    font-style: italic;
    color: var(--accent);
    margin-bottom: 0.5rem;
  }
  .persona-desc {
    font-size: 0.9rem;
    color: var(--muted);
    line-height: 1.6;
    font-style: italic;
  }
  /* Necessity gauge */
  .gauge-wrap {
    margin-bottom: 2rem;
  }
  .gauge-label {
    font-family: 'DM Mono', monospace;
    font-size: 0.65rem;
    letter-spacing: 0.2em;
    text-transform: uppercase;
    color: var(--accent);
    margin-bottom: 0.75rem;
    text-align: center;
  }
  .gauge-bar {
    height: 28px;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 4px;
    position: relative;
    overflow: hidden;
  }
  .gauge-fill {
    height: 100%;
    background: linear-gradient(90deg, var(--accent2), var(--accent));
    border-radius: 3px;
    transition: width 1.2s cubic-bezier(0.4, 0, 0.2, 1);
  }
  .gauge-labels {
    display: flex;
    justify-content: space-between;
    font-family: 'DM Mono', monospace;
    font-size: 0.6rem;
    color: var(--muted);
    margin-top: 0.3rem;
  }
  .gauge-pct {
    position: absolute;
    top: 50%; left: 50%;
    transform: translate(-50%, -50%);
    font-family: 'DM Mono', monospace;
    font-size: 0.75rem;
    color: var(--text);
    font-weight: 500;
    text-shadow: 0 1px 3px rgba(0,0,0,0.4);
  }
  /* Duel recap list */
  .recap-list {
    margin-bottom: 2rem;
  }
  .recap-item {
    display: flex;
    align-items: flex-start;
    gap: 0.75rem;
    padding: 0.75rem 0.6rem;
    border-bottom: 1px solid var(--border);
    font-size: 0.85rem;
    line-height: 1.45;
    text-align: left;
  }
  .recap-item:last-child { border-bottom: none; }
  .recap-num {
    font-family: 'DM Mono', monospace;
    font-size: 0.65rem;
    color: var(--muted);
    min-width: 1.5rem;
    text-align: center;
    padding-top: 0.15rem;
  }
  .recap-choice {
    flex: 1;
    color: var(--text);
  }
  .recap-co2 {
    font-family: 'DM Mono', monospace;
    font-size: 0.65rem;
    color: var(--muted);
    white-space: nowrap;
    padding-top: 0.15rem;
  }
  .recap-tag {
    font-family: 'DM Mono', monospace;
    font-size: 0.55rem;
    padding: 0.15rem 0.4rem;
    border-radius: 2px;
    white-space: nowrap;
    margin-top: 0.15rem;
    display: inline-block;
  }
  .recap-tag.majority {
    background: rgba(93, 138, 69, 0.15);
    color: var(--accent2);
  }
  .recap-tag.rebel {
    background: rgba(196, 92, 58, 0.15);
    color: var(--danger);
  }
  .recap-tag.contested {
    background: rgba(200, 168, 75, 0.12);
    color: var(--accent);
  }
  /* Boldest picks */
  .bold-picks {
    margin-bottom: 1.5rem;
  }
  .bold-pick-duel {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 6px;
    padding: 0.8rem 1rem;
    margin-bottom: 0.75rem;
  }
  .bold-duel-header {
    font-size: 0.8rem;
    font-weight: 600;
    color: var(--danger);
    margin-bottom: 0.5rem;
  }
  .bold-duel-options {
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }
  .bold-duel-chosen, .bold-duel-rejected {
    flex: 1;
    padding: 0.5rem;
    border-radius: 4px;
    font-size: 0.8rem;
    line-height: 1.4;
  }
  .bold-duel-chosen {
    background: rgba(93, 138, 69, 0.1);
    border: 1px solid rgba(93, 138, 69, 0.3);
  }
  .bold-duel-rejected {
    background: rgba(196, 92, 58, 0.05);
    border: 1px solid rgba(196, 92, 58, 0.15);
    opacity: 0.7;
  }
  .bold-duel-label {
    display: block;
    font-size: 0.65rem;
    font-weight: 600;
    text-transform: uppercase;
    margin-bottom: 0.25rem;
    letter-spacing: 0.03em;
  }
  .bold-duel-text {
    display: block;
    color: var(--text);
  }
  .bold-duel-vs {
    font-size: 0.7rem;
    font-weight: 700;
    color: var(--muted);
    flex-shrink: 0;
  }
  .bold-duel-stat {
    font-family: 'DM Mono', monospace;
    font-size: 0.7rem;
    color: var(--muted);
    margin-top: 0.5rem;
    text-align: center;
  }
  .results-insight {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 4px;
    padding: 1.5rem;
    margin-bottom: 1.5rem;
    font-size: 0.95rem;
    line-height: 1.7;
    color: var(--text);
    text-align: left;
  }
  .results-comparison {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 4px;
    padding: 1.5rem;
    margin-bottom: 2rem;
    text-align: left;
  }
  .comparison-title {
    font-family: 'DM Mono', monospace;
    font-size: 0.65rem;
    letter-spacing: 0.2em;
    text-transform: uppercase;
    color: var(--accent);
    margin-bottom: 1rem;
  }
  .comparison-stat {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.5rem 0;
    border-bottom: 1px solid var(--border);
    font-size: 0.85rem;
    color: var(--text);
  }
  .comparison-stat:last-child { border-bottom: none; }
  .comparison-value {
    font-family: 'DM Mono', monospace;
    font-size: 0.85rem;
    color: var(--accent);
    font-weight: 500;
  }
  .results-actions {
    display: flex;
    gap: 0.75rem;
    justify-content: center;
    flex-wrap: wrap;
    margin-top: 2.5rem;
  }
  .results-btn {
    font-family: 'DM Mono', monospace;
    font-size: 0.75rem;
    letter-spacing: 0.05em;
    padding: 0.75rem 1.5rem;
    border: 1px solid var(--border);
    background: none;
    color: var(--muted);
    border-radius: 3px;
    cursor: pointer;
    transition: all 0.25s ease;
  }
  .results-btn:hover { color: var(--text); border-color: var(--muted); }
  .results-btn.primary {
    background: var(--accent);
    border-color: var(--accent);
    color: var(--bg);
    font-weight: 500;
  }
  .results-btn.primary:hover {
    box-shadow: 0 6px 25px rgba(200, 168, 75, 0.35);
    transform: translateY(-2px);
  }

  /* ====== CONFETTI ====== */
  .confetti-container {
    position: fixed;
    inset: 0;
    pointer-events: none;
    z-index: 999;
    overflow: hidden;
  }
  .confetti-piece {
    position: absolute;
    width: 8px; height: 12px;
    top: -20px;
    animation: confetti-fall linear forwards;
  }
  @keyframes confetti-fall {
    0% { transform: translateY(0) rotateZ(0deg) rotateX(0deg); opacity: 1; }
    80% { opacity: 1; }
    100% { transform: translateY(105vh) rotateZ(720deg) rotateX(360deg); opacity: 0; }
  }

  /* ====== TOAST ====== */
  .toast {
    position: fixed;
    bottom: 2rem;
    left: 50%;
    transform: translateX(-50%) translateY(100px);
    background: var(--card);
    border: 1px solid var(--accent);
    color: var(--text);
    font-family: 'DM Mono', monospace;
    font-size: 0.75rem;
    padding: 0.75rem 1.5rem;
    border-radius: 4px;
    z-index: 1001;
    transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    box-shadow: 0 8px 30px var(--card-shadow);
  }
  .toast.visible { transform: translateX(-50%) translateY(0); }

  /* ====== SESSION COMPLETE BADGE ====== */
  .session-badge {
    display: inline-flex;
    align-items: center;
    gap: 0.4rem;
    font-family: 'DM Mono', monospace;
    font-size: 0.65rem;
    color: var(--accent2);
    background: rgba(93, 138, 69, 0.1);
    border: 1px solid rgba(93, 138, 69, 0.3);
    padding: 0.3rem 0.7rem;
    border-radius: 3px;
    margin-top: 0.5rem;
  }

  /* ====== RESPONSIVE for new elements ====== */
  @media (max-width: 640px) {
    .welcome-how { flex-direction: column; align-items: center; }
    .profile-label { width: 5rem; font-size: 0.6rem; }
    .profile-icon { width: 1.5rem; font-size: 1rem; }
    .progress-dots { gap: 0.35rem; }
    .progress-dot { width: 6px; height: 6px; }
    .results-actions { flex-direction: column; align-items: stretch; }
  }
</style>
</head>
<body>

<div class="mode-switcher" id="mode-switcher">
  <div class="mode-indicator">mode</div>
  <button class="mode-btn active" id="btn-standard" onclick="switchMode('standard')">
    <span class="mode-icon">üéØ</span>Standard
  </button>
  <button class="mode-btn" id="btn-labo" onclick="switchMode('labo')">
    <span class="mode-icon">üî¨</span>Labo recherche
  </button>
</div>

<button class="mode-btn theme-toggle" id="btn-theme" onclick="toggleTheme()">
  <span class="mode-icon" id="theme-icon">‚òÄÔ∏è</span>Light
</button>
</div>

<!-- ====== WELCOME OVERLAY ====== -->
<div class="welcome-overlay" id="welcome-overlay">
  <div class="welcome-content">
    <div class="welcome-label">EXP√âRIENCE PARTICIPATIVE</div>
    <h1 class="welcome-title">Dilemmes<br><em>Carbone</em></h1>
    <p class="welcome-desc">Chaque geste a un co√ªt climatique. En 13 dilemmes, d√©couvrez vos priorit√©s et comparez-les √† celles de la communaut√©.</p>
    <div class="welcome-badges">
      <span class="welcome-badge">‚è± ~3 min</span>
      <span class="welcome-badge">üîí 100 % anonyme</span>
      <span class="welcome-badge">üìä R√©sultats en direct</span>
    </div>
    <button class="welcome-start" onclick="startSession()">Commencer l'exp√©rience</button>
    <div class="welcome-count"><span id="welcome-votes">0</span> votes d√©j√† enregistr√©s</div>
    <div class="welcome-how">
      <div class="how-step">
        <div class="how-num">1</div>
        <div class="how-text">Lisez deux sc√©narios avec un co√ªt CO‚ÇÇ</div>
      </div>
      <div class="how-step">
        <div class="how-num">2</div>
        <div class="how-text">Choisissez celui que vous pr√©f√©rez √©mettre</div>
      </div>
      <div class="how-step">
        <div class="how-num">3</div>
        <div class="how-text">D√©couvrez votre profil carbone</div>
      </div>
    </div>
  </div>
</div>

<!-- ====== RESULTS OVERLAY ====== -->
<div class="results-overlay" id="results-overlay">
  <div class="results-content">
    <div class="results-label">SESSION TERMIN√âE ¬∑ 13 DILEMMES</div>
    <h2 class="results-title">Votre profil<br><em>carbone</em></h2>
    <p class="results-desc" id="results-desc">En 13 dilemmes, voici ce qui se dessine dans vos choix :</p>
    <div id="persona-container"></div>
    <div id="gauge-container"></div>
    <div id="bold-picks-container"></div>
    <div class="results-comparison" id="results-comparison"></div>
    <div id="recap-container"></div>
    <div class="results-actions">
      <button class="results-btn primary" onclick="shareResults()">üì§ Partager mes r√©sultats</button>
      <button class="results-btn" onclick="showLeaderboardFromResults()">üèÜ Voir le classement collectif</button>
      <button class="results-btn" onclick="restartSession()">üîÑ Recommencer (13 dilemmes)</button>
      <button class="results-btn" onclick="freePlay()">‚àû Continuer librement</button>
    </div>
  </div>
</div>

<!-- ====== CONFETTI CONTAINER ====== -->
<div class="confetti-container" id="confetti-container"></div>

<!-- ====== TOAST ====== -->
<div class="toast" id="toast"></div>

<header>
  <div class="header-label" id="header-label">√âthique climatique ¬∑ Exp√©rience participative</div>
  <h1>Quel <em>CO‚ÇÇ</em><br>choisir ?</h1>
  <p class="subtitle" id="subtitle">Chaque geste, chaque voyage, chaque usage num√©rique a un co√ªt climatique. Ces dilemmes vous invitent √† peser vos priorit√©s.</p>
  <div class="co2-badge">‚âà 50 √† 500 kg CO‚ÇÇ √©quivalent par option</div>
</header>

<div class="arena" id="arena">
  <!-- Progress bar -->
  <div class="progress-wrap" id="progress-wrap">
    <div class="progress-bar">
      <div class="progress-fill" id="progress-fill" style="width: 0%"></div>
    </div>
    <div class="progress-text" id="progress-text">1 / 13</div>
  </div>
  <div class="progress-dots" id="progress-dots"></div>

  <div class="question-label" id="pair-label">Duel #1 ‚Äî Lequel pr√©f√©reriez-vous √©mettre ?</div>

  <div class="duel" id="duel">
    <div class="choice-card" id="card-a" onclick="vote(0)" role="button" tabindex="0">
      <div class="card-letter">A</div>
      <div class="card-tag">Option A</div>
      <div class="card-text" id="text-a">‚Ä¶</div>
      <div class="card-co2" id="co2-wrap-a">üåø <span id="co2-a">~100 kg CO‚ÇÇ</span></div>
    </div>
    <div class="vs-divider">
      <div class="vs-line"></div>
      <div class="vs-text">ou</div>
      <div class="vs-line"></div>
    </div>
    <div class="choice-card" id="card-b" onclick="vote(1)" role="button" tabindex="0">
      <div class="card-letter">B</div>
      <div class="card-tag">Option B</div>
      <div class="card-text" id="text-b">‚Ä¶</div>
      <div class="card-co2" id="co2-wrap-b">üåø <span id="co2-b">~100 kg CO‚ÇÇ</span></div>
    </div>
  </div>

  <div class="post-vote-info" id="post-vote-info">
    <div class="equiv-bubble" id="equiv-bubble"></div>
    <div class="streak-msg" id="streak-msg"></div>
  </div>

  <div class="vote-counter">
    <strong id="total-votes">0</strong> votes collectifs enregistr√©s
  </div>

  <button class="skip-btn" onclick="nextPair()">Passer ce duel ‚Üí</button>

  <!-- Leaderboard -->
  <div class="leaderboard-section">
    <div class="section-header">
      <div class="section-title">Classement</div>
      <div class="section-mono">classement collectif ¬∑ en direct</div>
    </div>
    <div class="filter-tabs">
      <button class="tab-btn active" onclick="showRanking('preferred', this)">Les plus accept√©es</button>
      <button class="tab-btn" onclick="showRanking('refused', this)">Les plus refus√©es</button>
      <button class="tab-btn" onclick="showRanking('contested', this)">Les plus contest√©es</button>
    </div>
    <div class="leaderboard" id="leaderboard">
      <div class="no-votes">Votez pour voir le classement appara√Ætre‚Ä¶</div>
    </div>
  </div>
</div>

<footer>
  Les √©missions sont des estimations moyennes. Sources : ADEME, Our World in Data, IEA.<br>
  <em>50 ‚Äì 500 kg de CO‚ÇÇ</em> ‚âà dilemmes calibr√©s ADEME, empreinte annuelle FR ‚âà 10 t.
  <div class="db-status" id="db-status">
    <div class="live-dot" id="live-dot"></div>
    <span id="db-status-text">Connexion √† la base de donn√©es‚Ä¶</span>
  </div>
</footer>

<script type="module">
import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js';
import { getFirestore, collection, doc, setDoc, increment, onSnapshot, writeBatch } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';
import { standardProposals } from './proposals-standard.js';
import { laboProposals } from './proposals-labo.js';

const firebaseConfig = {
  apiKey: "AIzaSyBjBb9ta2_fkgmc40mbQZlMiWjuBdE5rM4",
  authDomain: "survey2-5d3a9.firebaseapp.com",
  projectId: "survey2-5d3a9",
  storageBucket: "survey2-5d3a9.firebasestorage.app",
  messagingSenderId: "1039782419824",
  appId: "1:1039782419824:web:b920750541df85545c03b5"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// =============================================
// Category metadata
// =============================================
const CAT_META_STD = {
  transport: { icon: 'üöó', label: 'Transport' },
  alimentation: { icon: 'üçñ', label: 'Alimentation' },
  num√©rique: { icon: 'üíª', label: 'Num√©rique' },
  √©nergie: { icon: '‚ö°', label: '√ânergie' },
  consommation: { icon: 'üõçÔ∏è', label: 'Consommation' },
  divers: { icon: 'üì¶', label: 'Divers' },
  m√©ta: { icon: 'ü§ñ', label: 'M√©ta' }
};
const CAT_META_LABO = {
  missions: { icon: '‚úàÔ∏è', label: 'Missions' },
  calcul: { icon: 'üñ•Ô∏è', label: 'Calcul HPC' },
  √©quipement: { icon: 'üîß', label: '√âquipement' },
  consommables: { icon: 'üß™', label: 'Consommables' },
  √©nergie: { icon: '‚ö°', label: '√ânergie' },
  terrain: { icon: 'üì°', label: 'Terrain' },
  enseignement: { icon: 'üìö', label: 'Enseignement' },
  m√©ta: { icon: 'ü§ñ', label: 'M√©ta' }
};

function getCat(id) {
  const num = parseInt(id.substring(1));
  if (id.startsWith('S')) {
    if (num <= 12) return 'transport';
    if (num <= 24) return 'alimentation';
    if (num <= 34) return 'num√©rique';
    if (num <= 42) return '√©nergie';
    if (num <= 50) return 'consommation';
    if (num <= 56) return 'divers';
    return 'm√©ta';
  }
  // Labo
  if (num <= 10) return 'missions';
  if (num <= 22) return 'calcul';
  if (num <= 30) return '√©quipement';
  if (num <= 38) return 'consommables';
  if (num <= 44) return '√©nergie';
  if (num <= 50) return 'terrain';
  if (num <= 54) return 'enseignement';
  return 'm√©ta';
}

function getCatMeta() {
  return currentAppMode === 'labo' ? CAT_META_LABO : CAT_META_STD;
}

// =============================================
// Mode management: standard vs labo
// =============================================
const MODES = {
  standard: {
    coll: 'carbone_standard',
    proposals: standardProposals,
    label: '√âthique climatique ¬∑ Exp√©rience participative',
    subtitle: 'Chaque geste, chaque voyage, chaque usage num√©rique a un co√ªt climatique. Ces dilemmes vous invitent √† peser vos priorit√©s.'
  },
  labo: {
    coll: 'carbone_labo',
    proposals: laboProposals,
    label: 'Labo de recherche ¬∑ Protocole scientifique',
    subtitle: 'Version recherche : vos r√©ponses alimentent une √©tude sur la perception des arbitrages carbone. Chaque vote compte pour la science.'
  }
};

let currentAppMode = 'standard';
let proposals = MODES[currentAppMode].proposals;
let scores = proposals.map(p => ({ id: p.id, text: p.text, co2: p.co2, wins: 0, losses: 0, elo: 1200 }));
let scoreById = Object.fromEntries(scores.map(s => [s.id, s]));
let totalVotes = 0;
let currentA = -1;
let currentB = -1;
let currentRankMode = 'preferred';
let voted = false;
let localDuelCount = 0;
let unsubscribe = null;

// =============================================
// SESSION MANAGEMENT (Moral Machine style)
// =============================================
const SESSION_SIZE = 13;
let sessionMode = true;      // true = structured 13-duel session
let sessionPairs = [];        // pre-generated pairs for this session
let sessionStep = 0;          // current step (0-indexed)
let sessionVotes = [];        // [{winnerIdx, loserIdx, winnerId, loserId}]

function shuffle(arr) {
  for (let i = arr.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [arr[i], arr[j]] = [arr[j], arr[i]];
  }
  return arr;
}

function generateSessionPairs() {
  const n = proposals.length;
  const pairs = [];

  // Thematic pairs: consecutive proposals (S01/S02, S03/S04...) = necessity vs comfort
  const thematicPairs = [];
  for (let i = 0; i < n - 1; i += 2) {
    thematicPairs.push([i, i + 1]);
  }
  shuffle(thematicPairs);

  // Take ~8 thematic pairs (strong ethical tension)
  const numThematic = Math.min(8, thematicPairs.length);
  for (let i = 0; i < numThematic && pairs.length < SESSION_SIZE; i++) {
    pairs.push(thematicPairs[i]);
  }

  // Fill remaining slots with cross-category random pairs
  let safety = 0;
  while (pairs.length < SESSION_SIZE && safety < 300) {
    const a = Math.floor(Math.random() * n);
    const b = Math.floor(Math.random() * n);
    if (a !== b) {
      const catA = getCat(proposals[a].id);
      const catB = getCat(proposals[b].id);
      if (catA !== catB && catA !== 'm√©ta' && catB !== 'm√©ta') {
        pairs.push([a, b]);
      }
    }
    safety++;
  }

  // Fallback if not enough cross-category
  while (pairs.length < SESSION_SIZE) {
    let a, b;
    do { a = Math.floor(Math.random() * n); b = Math.floor(Math.random() * n); } while (a === b);
    pairs.push([a, b]);
  }

  shuffle(pairs);
  return pairs.slice(0, SESSION_SIZE);
}

function initProgressDots() {
  const container = document.getElementById('progress-dots');
  container.innerHTML = '';
  for (let i = 0; i < SESSION_SIZE; i++) {
    const dot = document.createElement('div');
    dot.className = 'progress-dot' + (i === 0 ? ' current' : '');
    container.appendChild(dot);
  }
}

function updateProgress() {
  if (!sessionMode) {
    document.getElementById('progress-wrap').classList.remove('visible');
    document.getElementById('progress-dots').style.display = 'none';
    return;
  }

  document.getElementById('progress-wrap').classList.add('visible');
  document.getElementById('progress-dots').style.display = 'flex';

  const pct = (sessionStep / SESSION_SIZE) * 100;
  document.getElementById('progress-fill').style.width = `${pct}%`;
  document.getElementById('progress-text').textContent = `${sessionStep + 1} / ${SESSION_SIZE}`;

  // Update dots
  const dots = document.querySelectorAll('.progress-dot');
  dots.forEach((dot, i) => {
    dot.className = 'progress-dot';
    if (i < sessionStep) dot.classList.add('done');
    else if (i === sessionStep) dot.classList.add('current');
  });
}

// =============================================
// Welcome screen
// =============================================
function startSession() {
  // Hide welcome
  document.getElementById('welcome-overlay').classList.add('hidden');

  // Initialize session
  sessionMode = true;
  sessionStep = 0;
  sessionVotes = [];
  sessionPairs = generateSessionPairs();

  initProgressDots();
  updateProgress();
  updatePair();

  // Show header & arena
  document.querySelector('header').style.display = '';
  document.getElementById('arena').style.display = '';
}

// =============================================
// Results screen
// =============================================
function computeProfile() {
  let necessityCount = 0;
  let comfortCount = 0;
  let totalThematic = 0;
  let totalCO2Chosen = 0;
  let totalCO2Rejected = 0;
  let alignedWithMajority = 0;
  const rebelPicks = []; // choices where user disagrees with majority

  sessionVotes.forEach((v, i) => {
    totalCO2Chosen += proposals[v.winnerIdx].co2;
    totalCO2Rejected += proposals[v.loserIdx].co2;

    // Necessity vs comfort (thematic pairs: consecutive IDs)
    const wNum = parseInt(proposals[v.winnerIdx].id.substring(1));
    const lNum = parseInt(proposals[v.loserIdx].id.substring(1));
    if (Math.abs(wNum - lNum) === 1 && Math.min(wNum, lNum) % 2 === 1) {
      totalThematic++;
      if (wNum % 2 === 1) necessityCount++;
      else comfortCount++;
    }

    // Community alignment (ELO-based: compare chosen vs rejected in this duel)
    const winnerScore = scoreById[v.winnerId];
    const loserScore = scoreById[v.loserId];
    if (winnerScore && loserScore) {
      const wElo = winnerScore.elo || 1200;
      const lElo = loserScore.elo || 1200;
      // Expected probability that community agrees with this choice
      const expectedPct = Math.round(100 / (1 + Math.pow(10, (lElo - wElo) / 400)));
      if (expectedPct >= 50) {
        alignedWithMajority++;
      } else {
        rebelPicks.push({
          duelNum: i + 1,
          winnerText: proposals[v.winnerIdx].text,
          loserText: proposals[v.loserIdx].text,
          expectedPct,
          eloDiff: Math.round(wElo - lElo)
        });
      }
    } else {
      alignedWithMajority++; // no data = neutral
    }
  });

  // Sort rebel picks by how contrarian they are (lowest expected agreement first)
  rebelPicks.sort((a, b) => a.expectedPct - b.expectedPct);

  const avgCO2 = Math.round(totalCO2Chosen / sessionVotes.length);
  const alignPct = Math.round(alignedWithMajority / sessionVotes.length * 100);
  const necPct = totalThematic > 0 ? Math.round(necessityCount / totalThematic * 100) : null;

  return { necessityCount, comfortCount, totalThematic, necPct, avgCO2, alignPct, rebelPicks, totalCO2Chosen, totalCO2Rejected };
}

function getPersona(profile) {
  const { necPct, alignPct, rebelPicks } = profile;
  const rebels = rebelPicks.length;

  if (necPct !== null && necPct >= 80 && alignPct >= 60) {
    return { emoji: 'üõ°Ô∏è', name: 'Le Pragmatique', desc: 'Vous privil√©giez la n√©cessit√© et vous √™tes en phase avec le collectif. Votre boussole carbone est claire : l\'essentiel d\'abord.' };
  }
  if (necPct !== null && necPct >= 80 && alignPct < 60) {
    return { emoji: '‚öîÔ∏è', name: 'Le Convaincu', desc: 'Vous √™tes fermement du c√¥t√© de la n√©cessit√©, m√™me quand la majorit√© ne vous suit pas. Une vision tranch√©e.' };
  }
  if (rebels >= 5) {
    return { emoji: 'üî•', name: 'L\'Anticonformiste', desc: 'Vous n\'avez pas peur de penser diff√©remment. Vos choix sortent souvent du consensus ‚Äî vous avez vos propres crit√®res.' };
  }
  if (alignPct >= 80) {
    return { emoji: 'ü§ù', name: 'Le Consensuel', desc: 'Vos choix s\'alignent fortement avec la communaut√©. Vous refl√©tez l\'opinion collective sur ces dilemmes.' };
  }
  if (necPct !== null && necPct <= 30) {
    return { emoji: 'üé≠', name: 'L\'H√©doniste assum√©', desc: 'Le confort prime dans vos choix ‚Äî et vous l\'assumez. Le plaisir aussi a sa place dans l\'√©quation carbone.' };
  }
  if (necPct !== null && necPct >= 50 && necPct <= 70) {
    return { emoji: '‚öñÔ∏è', name: 'L\'√âquilibriste', desc: 'Vous naviguez entre n√©cessit√© et plaisir avec nuance. Vos choix montrent une r√©flexion au cas par cas.' };
  }
  return { emoji: 'üåç', name: 'Le Citoyen climato-conscient', desc: 'Vous pesez chaque dilemme avec attention. Vos 13 choix dessinent une sensibilit√© personnelle unique.' };
}

function showResults() {
  const profile = computeProfile();
  const persona = getPersona(profile);

  // --- Persona card ---
  document.getElementById('persona-container').innerHTML = `
    <div class="persona-card">
      <div class="persona-emoji">${persona.emoji}</div>
      <div class="persona-name">${persona.name}</div>
      <div class="persona-desc">${persona.desc}</div>
    </div>
  `;

  // --- Necessity vs Comfort gauge ---
  const gaugeContainer = document.getElementById('gauge-container');
  if (profile.necPct !== null) {
    gaugeContainer.innerHTML = `
      <div class="gauge-wrap">
        <div class="gauge-label">N√âCESSIT√â VS CONFORT</div>
        <div class="gauge-bar">
          <div class="gauge-fill" style="width: 0%" data-target="${profile.necPct}"></div>
          <div class="gauge-pct">${profile.necPct}% n√©cessit√©</div>
        </div>
        <div class="gauge-labels">
          <span>üé≠ Confort</span>
          <span>üõ°Ô∏è N√©cessit√©</span>
        </div>
      </div>
    `;
    setTimeout(() => {
      const fill = gaugeContainer.querySelector('.gauge-fill');
      if (fill) fill.style.width = fill.dataset.target + '%';
    }, 300);
  } else {
    gaugeContainer.innerHTML = '';
  }

  // --- Boldest / most rebel picks ---
  const boldContainer = document.getElementById('bold-picks-container');
  if (profile.rebelPicks.length > 0) {
    const topRebels = profile.rebelPicks.slice(0, 3);
    boldContainer.innerHTML = `
      <div class="bold-picks">
        <div class="gauge-label">VOS CHOIX LES PLUS AUDACIEUX</div>
        ${topRebels.map(r => `
          <div class="bold-pick-duel">
            <div class="bold-duel-header">‚ö° Duel #${r.duelNum}</div>
            <div class="bold-duel-options">
              <div class="bold-duel-chosen">
                <span class="bold-duel-label">‚úÖ Votre choix</span>
                <span class="bold-duel-text">${r.winnerText}</span>
              </div>
              <div class="bold-duel-vs">VS</div>
              <div class="bold-duel-rejected">
                <span class="bold-duel-label">‚ùå Rejet√©</span>
                <span class="bold-duel-text">${r.loserText}</span>
              </div>
            </div>
            <div class="bold-duel-stat">${r.expectedPct}% d'accord estim√© (ELO ${r.eloDiff > 0 ? '+' : ''}${r.eloDiff})</div>
          </div>
        `).join('')}
      </div>
    `;
  } else {
    boldContainer.innerHTML = '';
  }

  // --- Comparison stats ---
  const comparison = document.getElementById('results-comparison');
  let compHTML = '<div class="comparison-title">VOUS VS LA COMMUNAUT√â</div>';
  compHTML += `<div class="comparison-stat"><span>Alignement avec la majorit√©</span><span class="comparison-value">${profile.alignPct}%</span></div>`;
  compHTML += `<div class="comparison-stat"><span>CO‚ÇÇ moyen de vos choix</span><span class="comparison-value">${profile.avgCO2} kg</span></div>`;
  compHTML += `<div class="comparison-stat"><span>Duels compl√©t√©s</span><span class="comparison-value">${sessionVotes.length}</span></div>`;
  compHTML += `<div class="comparison-stat"><span>Votes collectifs au total</span><span class="comparison-value">${totalVotes.toLocaleString('fr-FR')}</span></div>`;
  if (profile.necPct !== null) {
    compHTML += `<div class="comparison-stat"><span>N√©cessit√© vs confort</span><span class="comparison-value">${profile.necPct}% n√©cessit√©</span></div>`;
  }
  comparison.innerHTML = compHTML;

  // --- Duel-by-duel recap ---
  const recapContainer = document.getElementById('recap-container');
  recapContainer.innerHTML = `
    <div class="recap-list">
      <div class="gauge-label" style="margin-bottom:0.75rem">VOS 13 CHOIX</div>
      ${sessionVotes.map((v, i) => {
        const wElo = scoreById[v.winnerId] ? scoreById[v.winnerId].elo || 1200 : 1200;
        const lElo = scoreById[v.loserId] ? scoreById[v.loserId].elo || 1200 : 1200;
        const expectedPct = Math.round(100 / (1 + Math.pow(10, (lElo - wElo) / 400)));
        let tagClass = 'majority', tagText = '';
        if (expectedPct >= 60) { tagClass = 'majority'; tagText = `${expectedPct}% d'accord`; }
        else if (expectedPct <= 40) { tagClass = 'rebel'; tagText = `${expectedPct}% d'accord`; }
        else { tagClass = 'contested'; tagText = `${expectedPct}% ‚Äî serr√©`; }
        return `<div class="recap-item">
          <div class="recap-num">${i + 1}</div>
          <div class="recap-choice">
            ${proposals[v.winnerIdx].text}
            ${tagText ? `<br><span class="recap-tag ${tagClass}">${tagText}</span>` : ''}
          </div>
          <div class="recap-co2">${proposals[v.winnerIdx].co2} kg</div>
        </div>`;
      }).join('')}
    </div>
  `;

  // Show overlay with animation
  const overlay = document.getElementById('results-overlay');
  overlay.classList.add('visible');

  // Launch confetti!
  launchConfetti();
}

function restartSession() {
  document.getElementById('results-overlay').classList.remove('visible');
  sessionMode = true;
  sessionStep = 0;
  sessionVotes = [];
  sessionPairs = generateSessionPairs();
  localDuelCount = 0;
  initProgressDots();
  updateProgress();
  updatePair();
}

function freePlay() {
  document.getElementById('results-overlay').classList.remove('visible');
  sessionMode = false;
  updateProgress();
  document.getElementById('pair-label').textContent =
    `Mode libre ‚Äî Lequel pr√©f√©reriez-vous √©mettre ?`;
  updatePair();
}

function showLeaderboardFromResults() {
  document.getElementById('results-overlay').classList.remove('visible');
  sessionMode = false;
  updateProgress();
  document.getElementById('pair-label').textContent =
    `Mode libre ‚Äî Lequel pr√©f√©reriez-vous √©mettre ?`;
  updatePair();
  setTimeout(() => {
    document.querySelector('.leaderboard-section').scrollIntoView({ behavior: 'smooth', block: 'start' });
  }, 300);
}

// =============================================
// Sharing (no cookies, no account ‚Äî Web Share API or clipboard)
// =============================================
function shareResults() {
  const profile = computeProfile();
  const persona = getPersona(profile);

  let text = `${persona.emoji} Mon profil Dilemmes Carbone : ${persona.name}\n\n`;
  text += `${persona.desc}\n\n`;
  text += `üìä Alignement communaut√© : ${profile.alignPct}%\n`;
  text += `üåø CO‚ÇÇ moyen de mes choix : ${profile.avgCO2} kg\n`;
  if (profile.necPct !== null) {
    text += `‚öñÔ∏è N√©cessit√© vs confort : ${profile.necPct}% n√©cessit√©\n`;
  }
  if (profile.rebelPicks.length > 0) {
    text += `‚ö° ${profile.rebelPicks.length} choix audacieux\n`;
  }

  text += `\nüîó https://pierromond.github.io/Carbone/`;

  if (navigator.share) {
    navigator.share({
      title: 'Mon profil Dilemmes Carbone',
      text: text,
      url: 'https://pierromond.github.io/Carbone/'
    }).catch(() => {});
  } else {
    navigator.clipboard.writeText(text).then(() => {
      showToast('üìã R√©sultats copi√©s dans le presse-papier !');
    }).catch(() => {
      showToast('Impossible de copier ‚Äî partagez le lien manuellement');
    });
  }
}

// =============================================
// Confetti animation
// =============================================
function launchConfetti() {
  const container = document.getElementById('confetti-container');
  container.innerHTML = '';
  const colors = ['#c8a84b', '#5d8a45', '#e8e4d4', '#c45c3a', '#7a7660', '#4a90d9'];
  const count = 80;

  for (let i = 0; i < count; i++) {
    const piece = document.createElement('div');
    piece.className = 'confetti-piece';
    piece.style.left = Math.random() * 100 + '%';
    piece.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
    piece.style.animationDuration = (2 + Math.random() * 2) + 's';
    piece.style.animationDelay = (Math.random() * 1.5) + 's';
    piece.style.width = (5 + Math.random() * 6) + 'px';
    piece.style.height = (8 + Math.random() * 8) + 'px';
    piece.style.borderRadius = Math.random() > 0.5 ? '50%' : '2px';
    container.appendChild(piece);
  }

  // Cleanup after animation
  setTimeout(() => { container.innerHTML = ''; }, 5000);
}

// =============================================
// Toast notification
// =============================================
function showToast(msg) {
  const toast = document.getElementById('toast');
  toast.textContent = msg;
  toast.classList.add('visible');
  setTimeout(() => toast.classList.remove('visible'), 3000);
}

// --- Database status indicator ---
function setDbStatus(online, detail) {
  const dot = document.getElementById('live-dot');
  const txt = document.getElementById('db-status-text');
  if (online) {
    dot.classList.remove('offline');
    txt.textContent = `Connect√© ¬∑ ${currentAppMode === 'labo' ? 'labo recherche' : 'standard'} ¬∑ votes en direct`;
  } else {
    dot.classList.add('offline');
    txt.textContent = detail || 'Hors ligne ¬∑ reconnexion en cours‚Ä¶';
  }
}

// --- ELO ---
function computeElo(scores) {
  scores.forEach(s => {
    const total = s.wins + s.losses;
    if (total === 0) { s.elo = 1200; return; }
    const winRate = s.wins / total;
    const clampedRate = Math.max(0.01, Math.min(0.99, winRate));
    s.elo = 1200 + 400 * Math.log10(clampedRate / (1 - clampedRate)) + Math.log2(total + 1) * 5;
  });
}

// --- Sound & haptic ---
let audioCtx = null;
function playClick() {
  try {
    if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    if (audioCtx.state === 'suspended') audioCtx.resume();
    const osc = audioCtx.createOscillator();
    const gain = audioCtx.createGain();
    osc.connect(gain);
    gain.connect(audioCtx.destination);
    osc.frequency.value = 600;
    gain.gain.setValueAtTime(0.02, audioCtx.currentTime);
    gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.06);
    osc.start(audioCtx.currentTime);
    osc.stop(audioCtx.currentTime + 0.08);
  } catch(e) {}
}

function playComplete() {
  try {
    if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    if (audioCtx.state === 'suspended') audioCtx.resume();
    const notes = [523, 659, 784]; // C5, E5, G5 ‚Äî cheerful chord
    notes.forEach((freq, i) => {
      const osc = audioCtx.createOscillator();
      const gain = audioCtx.createGain();
      osc.connect(gain);
      gain.connect(audioCtx.destination);
      osc.frequency.value = freq;
      const t = audioCtx.currentTime + i * 0.12;
      gain.gain.setValueAtTime(0.03, t);
      gain.gain.exponentialRampToValueAtTime(0.001, t + 0.4);
      osc.start(t);
      osc.stop(t + 0.5);
    });
  } catch(e) {}
}

// --- Post-vote info ---
function co2Equivalences(kg) {
  const km = Math.round(kg / 0.192);
  const pct = (kg / 10000 * 100).toFixed(1);
  return `üåç ${kg} kg CO‚ÇÇ ‚âà ${km} km en voiture ¬∑ ${pct} % empreinte annuelle FR`;
}

function showEquiv(kg) {
  const el = document.getElementById('equiv-bubble');
  el.textContent = co2Equivalences(kg);
  el.classList.add('visible');
}

function showStreak(pct) {
  const el = document.getElementById('streak-msg');
  if (pct >= 70) {
    el.textContent = `üî• Choix populaire ! Score ELO estim√© : ${pct}% en votre faveur`;
  } else if (pct <= 30) {
    el.textContent = `‚ö° Choix audacieux ! Score ELO : seulement ${pct}% en votre faveur`;
  } else {
    el.textContent = `‚öñÔ∏è Duel serr√© ‚Äî Score ELO : ${pct}% en votre faveur`;
  }
  el.classList.add('visible');
}

function hidePostVote() {
  document.getElementById('equiv-bubble').classList.remove('visible');
  document.getElementById('streak-msg').classList.remove('visible');
}

// --- Real-time Firestore listener ---
function listenForUpdates() {
  if (unsubscribe) unsubscribe();
  const coll = MODES[currentAppMode].coll;

  unsubscribe = onSnapshot(
    collection(db, coll),
    (snapshot) => {
      setDbStatus(true);
      let totalWins = 0;
      snapshot.forEach(docSnap => {
        const docId = docSnap.id;
        if (scoreById[docId]) {
          const data = docSnap.data();
          scoreById[docId].wins = data.wins || 0;
          scoreById[docId].losses = data.losses || 0;
          totalWins += (data.wins || 0);
        }
      });
      totalVotes = totalWins;
      computeElo(scores);
      document.getElementById('total-votes').textContent = totalVotes.toLocaleString('fr-FR');
      // Update welcome screen vote count too
      const welcomeVotes = document.getElementById('welcome-votes');
      if (welcomeVotes) welcomeVotes.textContent = totalVotes.toLocaleString('fr-FR');
      renderLeaderboard();
    },
    (error) => {
      console.error('Firestore listen error:', error);
      if (error.code === 'permission-denied') {
        setDbStatus(false, '‚ö†Ô∏è R√®gles Firestore expir√©es ‚Äî mettez √† jour les r√®gles dans la console Firebase');
      } else {
        setDbStatus(false, 'Hors ligne ¬∑ reconnexion en cours‚Ä¶');
      }
    }
  );
}

// --- Mode switch ---
function switchMode(mode) {
  if (mode === currentAppMode) return;
  currentAppMode = mode;
  proposals = MODES[mode].proposals;
  scores = proposals.map(p => ({ id: p.id, text: p.text, co2: p.co2, wins: 0, losses: 0, elo: 1200 }));
  scoreById = Object.fromEntries(scores.map(s => [s.id, s]));
  totalVotes = 0;

  document.getElementById('header-label').textContent = MODES[mode].label;
  document.getElementById('subtitle').textContent = MODES[mode].subtitle;
  document.getElementById('total-votes').textContent = '0';
  document.getElementById('leaderboard').innerHTML =
    '<div class="no-votes">Votez pour voir le classement appara√Ætre‚Ä¶</div>';

  document.getElementById('btn-standard').classList.toggle('active', mode === 'standard');
  document.getElementById('btn-labo').classList.toggle('active', mode === 'labo');

  const url = new URL(window.location);
  if (mode === 'standard') url.searchParams.delete('mode');
  else url.searchParams.set('mode', mode);
  history.replaceState(null, '', url);

  // Reinitialize session
  if (sessionMode) {
    sessionStep = 0;
    sessionVotes = [];
    sessionPairs = generateSessionPairs();
    initProgressDots();
    updateProgress();
  }

  listenForUpdates();
  updatePair();
}

// --- Pair management ---
function getRandomPair() {
  if (proposals.length < 2) return [0, 0];
  const maxPairIdx = Math.floor(proposals.length / 2);
  if (Math.random() < 0.1 && maxPairIdx > 0) {
    const p = Math.floor(Math.random() * maxPairIdx);
    return [p * 2, p * 2 + 1];
  }
  let a, b;
  do {
    a = Math.floor(Math.random() * proposals.length);
    b = Math.floor(Math.random() * proposals.length);
  } while (a === b);
  return [a, b];
}

function updatePair() {
  voted = false;
  localDuelCount++;
  hidePostVote();

  // Get pair: session mode or free play
  let a, b;
  if (sessionMode && sessionStep < SESSION_SIZE && sessionPairs.length > 0) {
    [a, b] = sessionPairs[sessionStep];
  } else {
    [a, b] = getRandomPair();
  }

  currentA = a;
  currentB = b;
  document.getElementById('text-a').textContent = proposals[a].text;
  document.getElementById('text-b').textContent = proposals[b].text;
  document.getElementById('co2-a').textContent = `~${proposals[a].co2} kg CO‚ÇÇ`;
  document.getElementById('co2-b').textContent = `~${proposals[b].co2} kg CO‚ÇÇ`;

  const wrapA = document.getElementById('co2-wrap-a');
  const wrapB = document.getElementById('co2-wrap-b');
  wrapA.className = 'card-co2';
  wrapB.className = 'card-co2';
  const coA = proposals[a].co2, coB = proposals[b].co2;
  if (coA && coB && Math.max(coA, coB) / Math.min(coA, coB) > 1.5) {
    if (coA > coB) { wrapA.classList.add('co2-high'); wrapB.classList.add('co2-low'); }
    else { wrapB.classList.add('co2-high'); wrapA.classList.add('co2-low'); }
  }

  // Update label
  if (sessionMode && sessionStep < SESSION_SIZE) {
    document.getElementById('pair-label').textContent =
      `Duel ${sessionStep + 1}/${SESSION_SIZE} ‚Äî Lequel pr√©f√©reriez-vous √©mettre ?`;
  } else {
    document.getElementById('pair-label').textContent =
      `Mode libre ¬∑ Duel #${localDuelCount} ‚Äî Lequel pr√©f√©reriez-vous √©mettre ?`;
  }

  const cardA = document.getElementById('card-a');
  const cardB = document.getElementById('card-b');
  cardA.classList.remove('winner', 'loser');
  cardB.classList.remove('winner', 'loser');
  cardA.style.opacity = '';
  cardB.style.opacity = '';
}

// --- Vote (writes to Firestore) ---
async function vote(choice) {
  if (voted) return;
  voted = true;

  const winnerIdx = choice === 0 ? currentA : currentB;
  const loserIdx  = choice === 0 ? currentB : currentA;
  const winnerId = proposals[winnerIdx].id;
  const loserId  = proposals[loserIdx].id;

  // Sound + haptic
  playClick();
  if (navigator.vibrate) navigator.vibrate(30);

  // Visual feedback
  const winCard  = choice === 0 ? 'card-a' : 'card-b';
  const loseCard = choice === 0 ? 'card-b' : 'card-a';
  document.getElementById(winCard).classList.add('winner');
  document.getElementById(loseCard).classList.add('loser');

  // Post-vote info
  showEquiv(proposals[winnerIdx].co2);
  const winnerElo = scoreById[winnerId] ? scoreById[winnerId].elo || 1200 : 1200;
  const loserElo = scoreById[loserId] ? scoreById[loserId].elo || 1200 : 1200;
  const eloPct = Math.round(100 / (1 + Math.pow(10, (loserElo - winnerElo) / 400)));
  if (totalVotes >= 3) {
    showStreak(eloPct);
  }

  // Track session vote
  if (sessionMode) {
    sessionVotes.push({ winnerIdx, loserIdx, winnerId, loserId });
    sessionStep++;
    updateProgress();
  }

  // Check if session is complete
  const sessionComplete = sessionMode && sessionStep >= SESSION_SIZE;

  // Transition to next duel (or results)
  const duel = document.getElementById('duel');
  setTimeout(() => {
    if (sessionComplete) {
      // Session complete! Show results after a brief pause
      playComplete();
      setTimeout(() => showResults(), 400);
    } else {
      duel.classList.add('transitioning');
      setTimeout(() => {
        updatePair();
        duel.classList.remove('transitioning');
      }, 300);
    }
  }, 2500);

  // Atomic Firestore update
  const coll = MODES[currentAppMode].coll;
  try {
    const batch = writeBatch(db);
    batch.set(doc(db, coll, winnerId), { wins: increment(1) }, { merge: true });
    batch.set(doc(db, coll, loserId), { losses: increment(1) }, { merge: true });
    await batch.commit();
  } catch (e) {
    console.error('Vote write error:', e);
    if (e.code === 'permission-denied') {
      setDbStatus(false, '‚ö†Ô∏è R√®gles Firestore expir√©es ‚Äî mettez √† jour les r√®gles dans la console Firebase');
    } else {
      setDbStatus(false);
    }
    scoreById[winnerId].wins++;
    scoreById[loserId].losses++;
    totalVotes++;
    computeElo(scores);
    document.getElementById('total-votes').textContent = totalVotes.toLocaleString('fr-FR');
    renderLeaderboard();
  }
}

// --- Ranking ---
function showRanking(mode, btn) {
  currentRankMode = mode;
  document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
  if (btn) btn.classList.add('active');
  renderLeaderboard();
}

function renderLeaderboard() {
  const lb = document.getElementById('leaderboard');
  const played = scores.filter(s => s.wins + s.losses > 0);

  if (played.length === 0) {
    lb.innerHTML = '<div class="no-votes">Votez pour voir le classement appara√Ætre‚Ä¶</div>';
    return;
  }

  let sorted;
  if (currentRankMode === 'preferred') {
    sorted = [...played].sort((a, b) => b.elo - a.elo);
  } else if (currentRankMode === 'refused') {
    sorted = [...played].sort((a, b) => a.elo - b.elo);
  } else {
    sorted = [...played].sort((a, b) => {
      const tA = a.wins + a.losses, tB = b.wins + b.losses;
      const rA = tA > 0 ? Math.abs(a.wins / tA - 0.5) : 1;
      const rB = tB > 0 ? Math.abs(b.wins / tB - 0.5) : 1;
      return rA - rB || tB - tA;
    });
  }

  const maxElo = Math.max(...sorted.map(s => s.elo));
  const minElo = Math.min(...sorted.map(s => s.elo));

  lb.innerHTML = sorted.map((s, i) => {
    const total = s.wins + s.losses;
    const winRate = Math.round(s.wins / total * 100);
    const barW = maxElo === minElo ? 50 : Math.round((s.elo - minElo) / (maxElo - minElo) * 100);
    const isTop3 = i < 3;
    const isLast = i === sorted.length - 1 && sorted.length > 3;
    const medal = i === 0 ? 'ü•á' : i === 1 ? 'ü•à' : i === 2 ? 'ü•â' : `${i + 1}`;

    return `<div class="rank-item ${isTop3 ? 'top-3' : ''} ${isLast ? 'last' : ''}">
      <div class="rank-num">${medal}</div>
      <div class="rank-text">${s.text} <span style="color:var(--muted);font-size:0.75rem">(${s.co2} kg)</span></div>
      <div class="rank-score">ELO ${Math.round(s.elo)} ¬∑ ${winRate}% (${total}v)</div>
      <div class="rank-bar-wrap">
        <div class="rank-bar" style="width:${barW}%"></div>
      </div>
    </div>`;
  }).join('');
}

// --- Expose to window for inline onclick handlers ---
window.vote = vote;
window.nextPair = function() {
  if (sessionMode && sessionStep < SESSION_SIZE) {
    // In session: skip counts as a duel, generate new pair for this slot
    const n = proposals.length;
    let a, b;
    do { a = Math.floor(Math.random() * n); b = Math.floor(Math.random() * n); } while (a === b);
    sessionPairs[sessionStep] = [a, b];
  }
  const duel = document.getElementById('duel');
  duel.classList.add('transitioning');
  setTimeout(() => {
    updatePair();
    duel.classList.remove('transitioning');
  }, 300);
};
window.showRanking = showRanking;
window.switchMode = switchMode;
window.startSession = startSession;
window.restartSession = restartSession;
window.freePlay = freePlay;
window.shareResults = shareResults;

// --- Theme toggle ---
function toggleTheme() {
  const html = document.documentElement;
  const isDark = html.getAttribute('data-theme') !== 'light';
  const next = isDark ? 'light' : 'dark';
  html.setAttribute('data-theme', next);
  localStorage.setItem('carbone-theme', next);
  const btn = document.getElementById('btn-theme');
  const icon = document.getElementById('theme-icon');
  if (next === 'light') {
    icon.textContent = 'üåô';
    btn.childNodes[1].textContent = 'Dark';
  } else {
    icon.textContent = '‚òÄÔ∏è';
    btn.childNodes[1].textContent = 'Light';
  }
}
window.toggleTheme = toggleTheme;

// Restore saved theme
(function() {
  const saved = localStorage.getItem('carbone-theme');
  if (saved === 'light') toggleTheme();
})();

// --- Keyboard accessibility ---
document.getElementById('card-a').addEventListener('keydown', e => {
  if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); vote(0); }
});
document.getElementById('card-b').addEventListener('keydown', e => {
  if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); vote(1); }
});
// Arrow keys for quick navigation
document.addEventListener('keydown', e => {
  if (e.key === 'ArrowLeft') vote(0);
  if (e.key === 'ArrowRight') vote(1);
});

// --- Initialize ---
// Show welcome screen; hide main content until "Start"
document.querySelector('header').style.display = 'none';
document.getElementById('arena').style.display = 'none';

// Start listening for vote counts (for welcome screen counter)
listenForUpdates();

// Read ?mode= from URL
const urlMode = new URLSearchParams(window.location.search).get('mode');
if (urlMode === 'labo') {
  currentAppMode = 'labo';
  proposals = MODES.labo.proposals;
  scores = proposals.map(p => ({ id: p.id, text: p.text, co2: p.co2, wins: 0, losses: 0, elo: 1200 }));
  scoreById = Object.fromEntries(scores.map(s => [s.id, s]));
  document.getElementById('btn-standard').classList.remove('active');
  document.getElementById('btn-labo').classList.add('active');
  listenForUpdates();
}

// Pre-generate first pair so it's ready when user starts
sessionPairs = generateSessionPairs();
updatePair();
</script>
</body>
</html>
