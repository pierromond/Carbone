<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>‚öñÔ∏è Dilemmes Carbone ‚Äî Une Tonne √† Choisir</title>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,700;0,900;1,700&family=DM+Mono:wght@400;500&family=Lora:ital@0;1&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #0e0e0b;
    --surface: #18180f;
    --card: #1e1e13;
    --border: #2e2e1e;
    --accent: #c8a84b;
    --accent2: #5d8a45;
    --text: #e8e4d4;
    --muted: #7a7660;
    --danger: #c45c3a;
    --glow: rgba(200, 168, 75, 0.15);
  }

  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'Lora', Georgia, serif;
    min-height: 100vh;
    overflow-x: hidden;
  }

  /* Grain overlay */
  body::before {
    content: '';
    position: fixed;
    inset: 0;
    background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.04'/%3E%3C/svg%3E");
    pointer-events: none;
    z-index: 1000;
    opacity: 0.5;
  }

  header {
    text-align: center;
    padding: 3rem 2rem 2rem;
    border-bottom: 1px solid var(--border);
    position: relative;
    overflow: hidden;
  }

  header::after {
    content: '';
    position: absolute;
    bottom: -1px;
    left: 50%;
    transform: translateX(-50%);
    width: 120px;
    height: 2px;
    background: var(--accent);
  }

  .header-label {
    font-family: 'DM Mono', monospace;
    font-size: 0.7rem;
    letter-spacing: 0.25em;
    text-transform: uppercase;
    color: var(--accent);
    margin-bottom: 1rem;
  }

  h1 {
    font-family: 'Playfair Display', Georgia, serif;
    font-size: clamp(2rem, 6vw, 4.5rem);
    font-weight: 900;
    line-height: 1.05;
    color: var(--text);
    margin-bottom: 0.75rem;
  }

  h1 em {
    font-style: italic;
    color: var(--accent);
  }

  .subtitle {
    font-size: 1rem;
    color: var(--muted);
    font-style: italic;
    max-width: 560px;
    margin: 0 auto;
    line-height: 1.6;
  }

  .co2-badge {
    display: inline-block;
    margin-top: 1.5rem;
    background: var(--glow);
    border: 1px solid var(--accent);
    border-radius: 2px;
    padding: 0.35rem 0.9rem;
    font-family: 'DM Mono', monospace;
    font-size: 0.75rem;
    letter-spacing: 0.1em;
    color: var(--accent);
  }

  /* Main arena */
  .arena {
    max-width: 960px;
    margin: 0 auto;
    padding: 3rem 1.5rem;
  }

  .question-label {
    font-family: 'DM Mono', monospace;
    font-size: 0.65rem;
    letter-spacing: 0.2em;
    text-transform: uppercase;
    color: var(--muted);
    text-align: center;
    margin-bottom: 2rem;
  }

  .duel {
    display: grid;
    grid-template-columns: 1fr auto 1fr;
    gap: 1.5rem;
    align-items: stretch;
    margin-bottom: 2.5rem;
  }

  .choice-card {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 4px;
    padding: 2.5rem 2rem;
    cursor: pointer;
    transition: all 0.25s ease;
    position: relative;
    overflow: hidden;
    display: flex;
    flex-direction: column;
    align-items: flex-start;
    gap: 1rem;
  }

  .choice-card::before {
    content: '';
    position: absolute;
    inset: 0;
    background: linear-gradient(135deg, var(--glow) 0%, transparent 60%);
    opacity: 0;
    transition: opacity 0.3s ease;
  }

  .choice-card:hover {
    border-color: var(--accent);
    transform: translateY(-3px);
    box-shadow: 0 12px 40px rgba(0,0,0,0.4), 0 0 0 1px var(--accent);
  }

  .choice-card:hover::before { opacity: 1; }

  .choice-card.winner {
    animation: winner-flash 0.6s ease forwards;
  }
  .choice-card.loser {
    animation: loser-fade 0.6s ease forwards;
  }

  @keyframes winner-flash {
    0% { background: var(--card); }
    40% { background: rgba(93, 138, 69, 0.3); border-color: var(--accent2); }
    100% { background: var(--card); }
  }
  @keyframes loser-fade {
    0% { opacity: 1; }
    100% { opacity: 0.3; }
  }

  .card-letter {
    font-family: 'Playfair Display', serif;
    font-size: 5rem;
    font-weight: 900;
    font-style: italic;
    color: var(--border);
    line-height: 1;
    position: absolute;
    top: 1rem;
    right: 1.5rem;
    transition: color 0.3s;
    user-select: none;
  }

  .choice-card:hover .card-letter { color: rgba(200, 168, 75, 0.2); }

  .card-tag {
    font-family: 'DM Mono', monospace;
    font-size: 0.6rem;
    letter-spacing: 0.2em;
    text-transform: uppercase;
    color: var(--accent);
    background: rgba(200, 168, 75, 0.1);
    padding: 0.2rem 0.5rem;
    border-radius: 2px;
  }

  .card-text {
    font-size: 1.1rem;
    line-height: 1.55;
    color: var(--text);
    position: relative;
    z-index: 1;
    flex: 1;
  }

  .card-co2 {
    font-family: 'DM Mono', monospace;
    font-size: 0.75rem;
    color: var(--muted);
    display: flex;
    align-items: center;
    gap: 0.4rem;
  }

  .card-co2 span {
    color: var(--accent);
    font-weight: 500;
  }

  .vs-divider {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    padding: 0 0.5rem;
  }

  .vs-line {
    width: 1px;
    flex: 1;
    background: var(--border);
  }

  .vs-text {
    font-family: 'Playfair Display', serif;
    font-size: 1.4rem;
    font-style: italic;
    color: var(--muted);
    writing-mode: vertical-rl;
    letter-spacing: 0.1em;
  }

  .vote-counter {
    text-align: center;
    font-family: 'DM Mono', monospace;
    font-size: 0.7rem;
    color: var(--muted);
    letter-spacing: 0.1em;
  }

  .vote-counter strong {
    color: var(--accent);
    font-size: 1.1rem;
  }

  .skip-btn {
    display: block;
    margin: 0 auto 3rem;
    background: none;
    border: 1px solid var(--border);
    color: var(--muted);
    font-family: 'DM Mono', monospace;
    font-size: 0.7rem;
    letter-spacing: 0.15em;
    text-transform: uppercase;
    padding: 0.5rem 1.5rem;
    cursor: pointer;
    border-radius: 2px;
    transition: all 0.2s ease;
  }

  .skip-btn:hover { color: var(--text); border-color: var(--muted); }

  /* Leaderboard */
  .leaderboard-section {
    border-top: 1px solid var(--border);
    padding-top: 3rem;
  }

  .section-header {
    display: flex;
    align-items: baseline;
    gap: 1rem;
    margin-bottom: 2rem;
  }

  .section-title {
    font-family: 'Playfair Display', serif;
    font-size: 1.8rem;
    font-weight: 700;
    font-style: italic;
  }

  .section-mono {
    font-family: 'DM Mono', monospace;
    font-size: 0.65rem;
    letter-spacing: 0.2em;
    text-transform: uppercase;
    color: var(--muted);
  }

  .leaderboard {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }

  .rank-item {
    display: grid;
    grid-template-columns: 3rem 1fr auto auto;
    align-items: center;
    gap: 1rem;
    padding: 0.9rem 1rem;
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 3px;
    transition: all 0.4s ease;
    position: relative;
    overflow: hidden;
  }

  .rank-item.top-3 {
    border-color: rgba(200, 168, 75, 0.4);
  }

  .rank-item.top-3::before {
    content: '';
    position: absolute;
    left: 0;
    top: 0;
    bottom: 0;
    width: 3px;
    background: var(--accent);
  }

  .rank-num {
    font-family: 'DM Mono', monospace;
    font-size: 0.8rem;
    color: var(--muted);
    text-align: center;
  }

  .rank-item.top-3 .rank-num {
    color: var(--accent);
    font-weight: 500;
  }

  .rank-text {
    font-size: 0.9rem;
    line-height: 1.4;
    color: var(--text);
  }

  .rank-score {
    font-family: 'DM Mono', monospace;
    font-size: 0.75rem;
    color: var(--accent2);
    white-space: nowrap;
  }

  .rank-bar-wrap {
    width: 80px;
    height: 4px;
    background: var(--border);
    border-radius: 2px;
    overflow: hidden;
  }

  .rank-bar {
    height: 100%;
    background: var(--accent);
    border-radius: 2px;
    transition: width 0.6s ease;
  }

  .rank-item.last .rank-bar {
    background: var(--danger);
  }

  .no-votes {
    color: var(--muted);
    font-style: italic;
    font-size: 0.85rem;
  }

  .filter-tabs {
    display: flex;
    gap: 0.5rem;
    margin-bottom: 1.5rem;
    flex-wrap: wrap;
  }

  .tab-btn {
    font-family: 'DM Mono', monospace;
    font-size: 0.65rem;
    letter-spacing: 0.15em;
    text-transform: uppercase;
    padding: 0.35rem 0.9rem;
    border: 1px solid var(--border);
    background: none;
    color: var(--muted);
    border-radius: 2px;
    cursor: pointer;
    transition: all 0.2s;
  }

  .tab-btn.active, .tab-btn:hover {
    background: var(--glow);
    border-color: var(--accent);
    color: var(--accent);
  }

  footer {
    text-align: center;
    padding: 3rem 2rem;
    border-top: 1px solid var(--border);
    margin-top: 4rem;
    font-family: 'DM Mono', monospace;
    font-size: 0.65rem;
    letter-spacing: 0.1em;
    color: var(--muted);
  }

  footer em { color: var(--accent); }

  @media (max-width: 640px) {
    .duel {
      grid-template-columns: 1fr;
      grid-template-rows: 1fr auto 1fr;
    }
    .vs-divider { flex-direction: row; padding: 0; }
    .vs-line { flex: 1; height: 1px; width: auto; }
    .vs-text { writing-mode: horizontal-tb; }
    .rank-bar-wrap { display: none; }
    .rank-item { grid-template-columns: 2.5rem 1fr auto; }
  }

  .db-status {
    display: inline-flex;
    align-items: center;
    gap: 0.4rem;
    margin-top: 0.75rem;
  }

  .live-dot {
    width: 6px;
    height: 6px;
    background: var(--accent2);
    border-radius: 50%;
    animation: pulse-live 2s infinite;
  }

  .live-dot.offline {
    background: var(--danger);
    animation: none;
  }

  @keyframes pulse-live {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.3; }
  }
</style>
</head>
<body>

<header>
  <div class="header-label">√âthique climatique ¬∑ Exp√©rience participative</div>
  <h1>Une tonne de<br><em>CO‚ÇÇ</em> √† choisir</h1>
  <p class="subtitle">Chaque geste, chaque voyage, chaque usage num√©rique a un co√ªt climatique. Ces dilemmes vous invitent √† peser vos priorit√©s.</p>
  <div class="co2-badge">‚âà 1 tonne CO‚ÇÇ √©quivalent par option</div>
</header>

<div class="arena">
  <div class="question-label" id="pair-label">Duel #1 sur 50 ‚Äî Lequel pr√©f√©reriez-vous √©mettre ?</div>

  <div class="duel" id="duel">
    <div class="choice-card" id="card-a" onclick="vote(0)">
      <div class="card-letter">A</div>
      <div class="card-tag">Option A</div>
      <div class="card-text" id="text-a">‚Ä¶</div>
      <div class="card-co2">üåø <span>~1 t CO‚ÇÇ</span></div>
    </div>
    <div class="vs-divider">
      <div class="vs-line"></div>
      <div class="vs-text">ou</div>
      <div class="vs-line"></div>
    </div>
    <div class="choice-card" id="card-b" onclick="vote(1)">
      <div class="card-letter">B</div>
      <div class="card-tag">Option B</div>
      <div class="card-text" id="text-b">‚Ä¶</div>
      <div class="card-co2">üåø <span>~1 t CO‚ÇÇ</span></div>
    </div>
  </div>

  <div class="vote-counter">
    <strong id="total-votes">0</strong> votes collectifs enregistr√©s
  </div>

  <button class="skip-btn" onclick="nextPair()">Passer ce duel ‚Üí</button>

  <!-- Leaderboard -->
  <div class="leaderboard-section">
    <div class="section-header">
      <div class="section-title">Classement</div>
      <div class="section-mono">classement collectif ¬∑ en direct</div>
    </div>
    <div class="filter-tabs">
      <button class="tab-btn active" onclick="showRanking('preferred', this)">Les plus accept√©es</button>
      <button class="tab-btn" onclick="showRanking('refused', this)">Les plus refus√©es</button>
      <button class="tab-btn" onclick="showRanking('contested', this)">Les plus contest√©es</button>
    </div>
    <div class="leaderboard" id="leaderboard">
      <div class="no-votes">Votez pour voir le classement appara√Ætre‚Ä¶</div>
    </div>
  </div>
</div>

<footer>
  Les √©missions sont des estimations moyennes. Sources : ADEME, Our World in Data, IEA.<br>
  <em>Une tonne de CO‚ÇÇ</em> = l'empreinte annuelle d'un habitant d'Inde en 2023.
  <div class="db-status" id="db-status">
    <div class="live-dot" id="live-dot"></div>
    <span id="db-status-text">Connexion √† la base de donn√©es‚Ä¶</span>
  </div>
</footer>

<script type="module">
import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js';
import { getFirestore, collection, doc, setDoc, increment, onSnapshot, writeBatch } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';

const firebaseConfig = {
  apiKey: "AIzaSyBjBb9ta2_fkgmc40mbQZlMiWjuBdE5rM4",
  authDomain: "survey2-5d3a9.firebaseapp.com",
  projectId: "survey2-5d3a9",
  storageBucket: "survey2-5d3a9.firebasestorage.app",
  messagingSenderId: "1039782419824",
  appId: "1:1039782419824:web:b920750541df85545c03b5"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const COLL = 'carbone';

const proposals = [
  "Prendre l'avion seul Paris ‚Üí New York (aller simple, classe √©co)",
  "Partir 2 semaines en vacances √† Lisbonne en avion depuis Paris (A/R)",
  "Faire un week-end √† Rome en avion (A/R) avec h√¥tel",
  "Conduire ma voiture diesel de Paris √† Nice et retour (environ 1 400 km A/R)",
  "Partir une semaine au ski en voiture avec deux amis, remont√©es m√©caniques incluses",
  "Manger un steak de b≈ìuf par semaine pendant toute une ann√©e",
  "Manger de la viande rouge (agneau, b≈ìuf) √† chaque repas du soir pendant 2 mois",
  "Acheter un iPhone dernier mod√®le neuf",
  "Remplacer mon ordinateur portable par un mod√®le neuf cette ann√©e",
  "Chauffer mon appartement au fioul pendant les 2 mois les plus froids de l'hiver",
  "Laisser mon chauffage √©lectrique allum√© en continu dans une pi√®ce pendant tout l'hiver",
  "Prendre ma voiture pour aller au travail tous les jours pendant 1 an (trajet 20 km A/R)",
  "Utiliser ChatGPT ou Claude plusieurs heures par jour pendant toute une ann√©e",
  "Regarder du streaming vid√©o (Netflix, YouTube) en 4K chaque soir pendant 1 an",
  "Acheter 10 v√™tements neufs par mois sur des sites de fast fashion pendant 1 an",
  "Faire livrer un colis en express depuis la Chine chaque semaine pendant 6 mois",
  "Acheter un canap√© en cuir neuf fabriqu√© en Asie et livr√© √† domicile",
  "Faire une croisi√®re de 10 jours en M√©diterran√©e",
  "Renouveler toute ma garde-robe (30 pi√®ces) en v√™tements neufs synth√©tiques",
  "Climatiser mon appartement tout l'√©t√© (juin‚Äìseptembre) en France",
  "Partir 3 semaines en road-trip aux √âtats-Unis avec voiture de location",
  "Acheter une paire de chaussures en cuir import√©e chaque mois pendant 1 an",
  "Faire construire et livrer un meuble sur mesure depuis l'Asie du Sud-Est",
  "Prendre l'avion pour des d√©placements professionnels 4 fois dans l'ann√©e (courts courriers)",
  "Consommer de l'alcool fort (whisky, cognac) r√©guli√®rement : 2 bouteilles/mois pendant 1 an",
  "Manger du fromage √† p√¢te dure (parmesan, comt√©) tous les jours pendant 1 an",
  "Acheter un √©cran TV 75 pouces neuf et le regarder 5h par jour pendant 1 an",
  "Faire r√©nover ma salle de bain (carrelage, baignoire, plomberie) avec artisans",
  "Aller √† la salle de sport en voiture (5 km A/R) 4 fois par semaine pendant 1 an",
  "Prendre une douche de 15 minutes chaque matin avec un chauffe-eau √©lectrique ancien",
  "Acheter et utiliser un robot aspirateur + robot tondeuse neufs",
  "Partir en voyage de noces 2 semaines √† Bali en avion (A/R depuis Paris)",
  "Manger un burger avec steak hach√© au d√©jeuner chaque jour pendant 4 mois",
  "Acheter un v√©hicule √©lectrique neuf (en comptant la fabrication de la batterie)",
  "Chauffer ma r√©sidence secondaire de campagne tout l'hiver √† distance",
  "Acheter 1 jeu vid√©o par semaine sur console neuve pendant 1 an",
  "Me faire livrer mes courses √† domicile chaque semaine pendant 1 an (van diesel)",
  "Faire un tatouage au laser (plusieurs s√©ances sous anesth√©sie locale en clinique)",
  "Boire un caf√© capsule par jour pendant 5 ans (production + machine)",
  "Acheter une montre connect√©e neuve par an pendant 3 ans",
  "Faire appel √† un plombier en urgence (d√©placement van diesel, pi√®ces import√©es)",
  "Aller √† un concert √† l'√©tranger en avion (week-end Paris ‚Üí Londres ‚Üí retour)",
  "Partir en week-end √† Amsterdam en voiture seul depuis Paris (A/R ~500 km)",
  "Manger des crevettes tropicales import√©es par avion une fois par semaine pendant 1 an",
  "Laisser mon ordinateur allum√© 24h/24 pendant toute une ann√©e sans veille",
  "Prendre l'avion Paris ‚Üí Barcelone au lieu du train (A/R)",
  "Acheter et faire fonctionner une imprimante laser couleur √† la maison pendant 3 ans",
  "Faire tondre ma pelouse avec un robot thermique tout l'√©t√© pendant 5 ans",
  "Consommer du lait entier de vache chaque jour pendant 7 ans (environ 2L/semaine)",
  "Prendre un taxi ou VTC pour tous mes d√©placements en ville pendant 6 mois"
];

let scores = proposals.map((text, i) => ({ id: i, text, wins: 0, losses: 0 }));
let totalVotes = 0;
let currentA = -1;
let currentB = -1;
let currentMode = 'preferred';
let voted = false;

// --- Database status indicator ---
function setDbStatus(online) {
  const dot = document.getElementById('live-dot');
  const txt = document.getElementById('db-status-text');
  if (online) {
    dot.classList.remove('offline');
    txt.textContent = 'Base de donn√©es connect√©e ¬∑ votes partag√©s en direct';
  } else {
    dot.classList.add('offline');
    txt.textContent = 'Hors ligne ¬∑ reconnexion en cours‚Ä¶';
  }
}

// --- Real-time Firestore listener ---
function listenForUpdates() {
  onSnapshot(
    collection(db, COLL),
    (snapshot) => {
      setDbStatus(true);
      let totalWins = 0;
      snapshot.forEach(docSnap => {
        const idx = parseInt(docSnap.id);
        if (!isNaN(idx) && idx >= 0 && idx < proposals.length) {
          const data = docSnap.data();
          scores[idx].wins = data.wins || 0;
          scores[idx].losses = data.losses || 0;
          totalWins += (data.wins || 0);
        }
      });
      totalVotes = totalWins;
      document.getElementById('total-votes').textContent = totalVotes;
      renderLeaderboard();
    },
    (error) => {
      console.error('Firestore listen error:', error);
      setDbStatus(false);
    }
  );
}

// --- Pair management ---
function getRandomPair() {
  let a, b;
  do {
    a = Math.floor(Math.random() * proposals.length);
    b = Math.floor(Math.random() * proposals.length);
  } while (a === b);
  return [a, b];
}

function updatePair() {
  voted = false;
  const [a, b] = getRandomPair();
  currentA = a;
  currentB = b;
  document.getElementById('text-a').textContent = proposals[a];
  document.getElementById('text-b').textContent = proposals[b];
  document.getElementById('pair-label').textContent =
    `Duel #${totalVotes + 1} ‚Äî Lequel pr√©f√©reriez-vous √©mettre ?`;
  const cardA = document.getElementById('card-a');
  const cardB = document.getElementById('card-b');
  cardA.classList.remove('winner', 'loser');
  cardB.classList.remove('winner', 'loser');
  cardA.style.opacity = '';
  cardB.style.opacity = '';
}

// --- Vote (writes to Firestore) ---
async function vote(choice) {
  if (voted) return;
  voted = true;

  const winnerIdx = choice === 0 ? currentA : currentB;
  const loserIdx  = choice === 0 ? currentB : currentA;

  // Visual feedback
  const winCard  = choice === 0 ? 'card-a' : 'card-b';
  const loseCard = choice === 0 ? 'card-b' : 'card-a';
  document.getElementById(winCard).classList.add('winner');
  document.getElementById(loseCard).classList.add('loser');

  // Atomic Firestore update
  try {
    const batch = writeBatch(db);
    batch.set(doc(db, COLL, String(winnerIdx)), { wins: increment(1) }, { merge: true });
    batch.set(doc(db, COLL, String(loserIdx)), { losses: increment(1) }, { merge: true });
    await batch.commit();
  } catch (e) {
    console.error('Vote write error:', e);
    setDbStatus(false);
    // Optimistic local fallback
    scores[winnerIdx].wins++;
    scores[loserIdx].losses++;
    totalVotes++;
    document.getElementById('total-votes').textContent = totalVotes;
    renderLeaderboard();
  }

  setTimeout(updatePair, 900);
}

// --- Ranking ---
function showRanking(mode, btn) {
  currentMode = mode;
  document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
  if (btn) btn.classList.add('active');
  renderLeaderboard();
}

function renderLeaderboard() {
  const lb = document.getElementById('leaderboard');
  const played = scores.filter(s => s.wins + s.losses > 0);

  if (played.length === 0) {
    lb.innerHTML = '<div class="no-votes">Votez pour voir le classement appara√Ætre‚Ä¶</div>';
    return;
  }

  let sorted;
  if (currentMode === 'preferred') {
    sorted = [...played].sort((a, b) => {
      const rA = a.wins / (a.wins + a.losses);
      const rB = b.wins / (b.wins + b.losses);
      return rB - rA || (b.wins + b.losses) - (a.wins + a.losses);
    });
  } else if (currentMode === 'refused') {
    sorted = [...played].sort((a, b) => {
      const rA = a.wins / (a.wins + a.losses);
      const rB = b.wins / (b.wins + b.losses);
      return rA - rB || (b.wins + b.losses) - (a.wins + a.losses);
    });
  } else {
    // Contested: closest to 50% win rate with most votes
    sorted = [...played].sort((a, b) => {
      const tA = a.wins + a.losses, tB = b.wins + b.losses;
      const rA = tA > 0 ? Math.abs(a.wins / tA - 0.5) : 1;
      const rB = tB > 0 ? Math.abs(b.wins / tB - 0.5) : 1;
      return rA - rB || tB - tA;
    });
  }

  const rates = sorted.map(s => s.wins / (s.wins + s.losses));
  const maxR = Math.max(...rates);
  const minR = Math.min(...rates);

  lb.innerHTML = sorted.map((s, i) => {
    const total = s.wins + s.losses;
    const winRate = Math.round(s.wins / total * 100);
    const rate = s.wins / total;
    const barW = maxR === minR ? 50 : Math.round((rate - minR) / (maxR - minR) * 100);
    const isTop3 = i < 3;
    const isLast = i === sorted.length - 1 && sorted.length > 3;
    const medal = i === 0 ? 'ü•á' : i === 1 ? 'ü•à' : i === 2 ? 'ü•â' : `${i + 1}`;

    return `<div class="rank-item ${isTop3 ? 'top-3' : ''} ${isLast ? 'last' : ''}">
      <div class="rank-num">${medal}</div>
      <div class="rank-text">${s.text.substring(0, 90)}${s.text.length > 90 ? '‚Ä¶' : ''}</div>
      <div class="rank-score">${winRate}% (${total}v)</div>
      <div class="rank-bar-wrap">
        <div class="rank-bar" style="width:${barW}%"></div>
      </div>
    </div>`;
  }).join('');
}

// --- Expose to window for inline onclick handlers ---
window.vote = vote;
window.nextPair = function() { updatePair(); };
window.showRanking = showRanking;

// --- Initialize ---
updatePair();
listenForUpdates();
</script>
</body>
</html>
