<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>‚öñÔ∏è Dilemmes Carbone ‚Äî 100 kg √† Choisir</title>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,700;0,900;1,700&family=DM+Mono:wght@400;500&family=Lora:ital@0;1&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #0e0e0b;
    --surface: #18180f;
    --card: #1e1e13;
    --border: #2e2e1e;
    --accent: #c8a84b;
    --accent2: #5d8a45;
    --text: #e8e4d4;
    --muted: #7a7660;
    --danger: #c45c3a;
    --glow: rgba(200, 168, 75, 0.15);
  }

  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'Lora', Georgia, serif;
    min-height: 100vh;
    overflow-x: hidden;
  }

  /* Grain overlay */
  body::before {
    content: '';
    position: fixed;
    inset: 0;
    background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.04'/%3E%3C/svg%3E");
    pointer-events: none;
    z-index: 1000;
    opacity: 0.5;
  }

  header {
    text-align: center;
    padding: 3rem 2rem 2rem;
    border-bottom: 1px solid var(--border);
    position: relative;
    overflow: hidden;
  }

  header::after {
    content: '';
    position: absolute;
    bottom: -1px;
    left: 50%;
    transform: translateX(-50%);
    width: 120px;
    height: 2px;
    background: var(--accent);
  }

  .header-label {
    font-family: 'DM Mono', monospace;
    font-size: 0.7rem;
    letter-spacing: 0.25em;
    text-transform: uppercase;
    color: var(--accent);
    margin-bottom: 1rem;
  }

  h1 {
    font-family: 'Playfair Display', Georgia, serif;
    font-size: clamp(2rem, 6vw, 4.5rem);
    font-weight: 900;
    line-height: 1.05;
    color: var(--text);
    margin-bottom: 0.75rem;
  }

  h1 em {
    font-style: italic;
    color: var(--accent);
  }

  .subtitle {
    font-size: 1rem;
    color: var(--muted);
    font-style: italic;
    max-width: 560px;
    margin: 0 auto;
    line-height: 1.6;
  }

  .co2-badge {
    display: inline-block;
    margin-top: 1.5rem;
    background: var(--glow);
    border: 1px solid var(--accent);
    border-radius: 2px;
    padding: 0.35rem 0.9rem;
    font-family: 'DM Mono', monospace;
    font-size: 0.75rem;
    letter-spacing: 0.1em;
    color: var(--accent);
  }

  /* Main arena */
  .arena {
    max-width: 960px;
    margin: 0 auto;
    padding: 3rem 1.5rem;
  }

  .question-label {
    font-family: 'DM Mono', monospace;
    font-size: 0.65rem;
    letter-spacing: 0.2em;
    text-transform: uppercase;
    color: var(--muted);
    text-align: center;
    margin-bottom: 2rem;
  }

  .duel {
    display: grid;
    grid-template-columns: 1fr auto 1fr;
    gap: 1.5rem;
    align-items: stretch;
    margin-bottom: 2.5rem;
  }

  .choice-card {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 4px;
    padding: 2.5rem 2rem;
    cursor: pointer;
    transition: all 0.25s ease;
    position: relative;
    overflow: hidden;
    display: flex;
    flex-direction: column;
    align-items: flex-start;
    gap: 1rem;
  }

  .choice-card::before {
    content: '';
    position: absolute;
    inset: 0;
    background: linear-gradient(135deg, var(--glow) 0%, transparent 60%);
    opacity: 0;
    transition: opacity 0.3s ease;
  }

  .choice-card:hover {
    border-color: var(--accent);
    transform: translateY(-3px);
    box-shadow: 0 12px 40px rgba(0,0,0,0.4), 0 0 0 1px var(--accent);
  }

  .choice-card:hover::before { opacity: 1; }

  .choice-card.winner {
    animation: winner-flash 0.6s ease forwards;
  }
  .choice-card.loser {
    animation: loser-fade 0.6s ease forwards;
  }

  @keyframes winner-flash {
    0% { background: var(--card); }
    40% { background: rgba(93, 138, 69, 0.3); border-color: var(--accent2); }
    100% { background: var(--card); }
  }
  @keyframes loser-fade {
    0% { opacity: 1; }
    100% { opacity: 0.3; }
  }

  .card-letter {
    font-family: 'Playfair Display', serif;
    font-size: 5rem;
    font-weight: 900;
    font-style: italic;
    color: var(--border);
    line-height: 1;
    position: absolute;
    top: 1rem;
    right: 1.5rem;
    transition: color 0.3s;
    user-select: none;
  }

  .choice-card:hover .card-letter { color: rgba(200, 168, 75, 0.2); }

  .card-tag {
    font-family: 'DM Mono', monospace;
    font-size: 0.6rem;
    letter-spacing: 0.2em;
    text-transform: uppercase;
    color: var(--accent);
    background: rgba(200, 168, 75, 0.1);
    padding: 0.2rem 0.5rem;
    border-radius: 2px;
  }

  .card-text {
    font-size: 1.1rem;
    line-height: 1.55;
    color: var(--text);
    position: relative;
    z-index: 1;
    flex: 1;
  }

  .card-co2 {
    font-family: 'DM Mono', monospace;
    font-size: 0.75rem;
    color: var(--muted);
    display: flex;
    align-items: center;
    gap: 0.4rem;
  }

  .card-co2 span {
    color: var(--accent);
    font-weight: 500;
  }

  .vs-divider {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    padding: 0 0.5rem;
  }

  .vs-line {
    width: 1px;
    flex: 1;
    background: var(--border);
  }

  .vs-text {
    font-family: 'Playfair Display', serif;
    font-size: 1.4rem;
    font-style: italic;
    color: var(--muted);
    writing-mode: vertical-rl;
    letter-spacing: 0.1em;
  }

  .vote-counter {
    text-align: center;
    font-family: 'DM Mono', monospace;
    font-size: 0.7rem;
    color: var(--muted);
    letter-spacing: 0.1em;
  }

  .vote-counter strong {
    color: var(--accent);
    font-size: 1.1rem;
  }

  .skip-btn {
    display: block;
    margin: 0 auto 3rem;
    background: none;
    border: 1px solid var(--border);
    color: var(--muted);
    font-family: 'DM Mono', monospace;
    font-size: 0.7rem;
    letter-spacing: 0.15em;
    text-transform: uppercase;
    padding: 0.5rem 1.5rem;
    cursor: pointer;
    border-radius: 2px;
    transition: all 0.2s ease;
  }

  .skip-btn:hover { color: var(--text); border-color: var(--muted); }

  /* Leaderboard */
  .leaderboard-section {
    border-top: 1px solid var(--border);
    padding-top: 3rem;
  }

  .section-header {
    display: flex;
    align-items: baseline;
    gap: 1rem;
    margin-bottom: 2rem;
  }

  .section-title {
    font-family: 'Playfair Display', serif;
    font-size: 1.8rem;
    font-weight: 700;
    font-style: italic;
  }

  .section-mono {
    font-family: 'DM Mono', monospace;
    font-size: 0.65rem;
    letter-spacing: 0.2em;
    text-transform: uppercase;
    color: var(--muted);
  }

  .leaderboard {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }

  .rank-item {
    display: grid;
    grid-template-columns: 3rem 1fr auto auto;
    align-items: center;
    gap: 1rem;
    padding: 0.9rem 1rem;
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 3px;
    transition: all 0.4s ease;
    position: relative;
    overflow: hidden;
  }

  .rank-item.top-3 {
    border-color: rgba(200, 168, 75, 0.4);
  }

  .rank-item.top-3::before {
    content: '';
    position: absolute;
    left: 0;
    top: 0;
    bottom: 0;
    width: 3px;
    background: var(--accent);
  }

  .rank-num {
    font-family: 'DM Mono', monospace;
    font-size: 0.8rem;
    color: var(--muted);
    text-align: center;
  }

  .rank-item.top-3 .rank-num {
    color: var(--accent);
    font-weight: 500;
  }

  .rank-text {
    font-size: 0.9rem;
    line-height: 1.4;
    color: var(--text);
  }

  .rank-score {
    font-family: 'DM Mono', monospace;
    font-size: 0.75rem;
    color: var(--accent2);
    white-space: nowrap;
  }

  .rank-bar-wrap {
    width: 80px;
    height: 4px;
    background: var(--border);
    border-radius: 2px;
    overflow: hidden;
  }

  .rank-bar {
    height: 100%;
    background: var(--accent);
    border-radius: 2px;
    transition: width 0.6s ease;
  }

  .rank-item.last .rank-bar {
    background: var(--danger);
  }

  .no-votes {
    color: var(--muted);
    font-style: italic;
    font-size: 0.85rem;
  }

  .filter-tabs {
    display: flex;
    gap: 0.5rem;
    margin-bottom: 1.5rem;
    flex-wrap: wrap;
  }

  .tab-btn {
    font-family: 'DM Mono', monospace;
    font-size: 0.65rem;
    letter-spacing: 0.15em;
    text-transform: uppercase;
    padding: 0.35rem 0.9rem;
    border: 1px solid var(--border);
    background: none;
    color: var(--muted);
    border-radius: 2px;
    cursor: pointer;
    transition: all 0.2s;
  }

  .tab-btn.active, .tab-btn:hover {
    background: var(--glow);
    border-color: var(--accent);
    color: var(--accent);
  }

  footer {
    text-align: center;
    padding: 3rem 2rem;
    border-top: 1px solid var(--border);
    margin-top: 4rem;
    font-family: 'DM Mono', monospace;
    font-size: 0.65rem;
    letter-spacing: 0.1em;
    color: var(--muted);
  }

  footer em { color: var(--accent); }

  @media (max-width: 640px) {
    .duel {
      grid-template-columns: 1fr;
      grid-template-rows: 1fr auto 1fr;
    }
    .vs-divider { flex-direction: row; padding: 0; }
    .vs-line { flex: 1; height: 1px; width: auto; }
    .vs-text { writing-mode: horizontal-tb; }
    .rank-bar-wrap { display: none; }
    .rank-item { grid-template-columns: 2.5rem 1fr auto; }
  }

  .db-status {
    display: inline-flex;
    align-items: center;
    gap: 0.4rem;
    margin-top: 0.75rem;
  }

  .live-dot {
    width: 6px;
    height: 6px;
    background: var(--accent2);
    border-radius: 50%;
    animation: pulse-live 2s infinite;
  }

  .live-dot.offline {
    background: var(--danger);
    animation: none;
  }

  @keyframes pulse-live {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.3; }
  }

  /* Mode switcher */
  .mode-switcher {
    position: fixed;
    top: 1rem;
    left: 1rem;
    z-index: 999;
    display: flex;
    flex-direction: column;
    gap: 0.35rem;
  }

  .mode-btn {
    font-family: 'DM Mono', monospace;
    font-size: 0.6rem;
    letter-spacing: 0.1em;
    text-transform: uppercase;
    padding: 0.4rem 0.75rem;
    border: 1px solid var(--border);
    background: var(--surface);
    color: var(--muted);
    border-radius: 3px;
    cursor: pointer;
    transition: all 0.25s ease;
    white-space: nowrap;
    text-align: left;
  }

  .mode-btn:hover {
    border-color: var(--muted);
    color: var(--text);
  }

  .mode-btn.active {
    background: var(--glow);
    border-color: var(--accent);
    color: var(--accent);
    box-shadow: 0 0 12px rgba(200, 168, 75, 0.15);
  }

  .mode-btn .mode-icon {
    margin-right: 0.3rem;
  }

  .mode-indicator {
    font-family: 'DM Mono', monospace;
    font-size: 0.55rem;
    letter-spacing: 0.15em;
    text-transform: uppercase;
    color: var(--muted);
    padding: 0 0.2rem;
  }

  @media (max-width: 640px) {
    .mode-switcher {
      position: relative;
      top: auto;
      left: auto;
      flex-direction: row;
      justify-content: center;
      padding: 0.75rem 1rem 0;
    }
  }
</style>
</head>
<body>

<div class="mode-switcher" id="mode-switcher">
  <div class="mode-indicator">mode</div>
  <button class="mode-btn active" id="btn-standard" onclick="switchMode('standard')">
    <span class="mode-icon">üéØ</span>Standard
  </button>
  <button class="mode-btn" id="btn-labo" onclick="switchMode('labo')">
    <span class="mode-icon">üî¨</span>Labo recherche
  </button>
</div>

<header>
  <div class="header-label" id="header-label">√âthique climatique ¬∑ Exp√©rience participative</div>
  <h1>100 kg de<br><em>CO‚ÇÇ</em> √† choisir</h1>
  <p class="subtitle" id="subtitle">Chaque geste, chaque voyage, chaque usage num√©rique a un co√ªt climatique. Ces dilemmes vous invitent √† peser vos priorit√©s.</p>
  <div class="co2-badge">‚âà 50 √† 500 kg CO‚ÇÇ √©quivalent par option</div>
</header>

<div class="arena">
  <div class="question-label" id="pair-label">Duel #1 sur 50 ‚Äî Lequel pr√©f√©reriez-vous √©mettre ?</div>

  <div class="duel" id="duel">
    <div class="choice-card" id="card-a" onclick="vote(0)">
      <div class="card-letter">A</div>
      <div class="card-tag">Option A</div>
      <div class="card-text" id="text-a">‚Ä¶</div>
      <div class="card-co2">üåø <span id="co2-a">~100 kg CO‚ÇÇ</span></div>
    </div>
    <div class="vs-divider">
      <div class="vs-line"></div>
      <div class="vs-text">ou</div>
      <div class="vs-line"></div>
    </div>
    <div class="choice-card" id="card-b" onclick="vote(1)">
      <div class="card-letter">B</div>
      <div class="card-tag">Option B</div>
      <div class="card-text" id="text-b">‚Ä¶</div>
      <div class="card-co2">üåø <span id="co2-b">~100 kg CO‚ÇÇ</span></div>
    </div>
  </div>

  <div class="vote-counter">
    <strong id="total-votes">0</strong> votes collectifs enregistr√©s
  </div>

  <button class="skip-btn" onclick="nextPair()">Passer ce duel ‚Üí</button>

  <!-- Leaderboard -->
  <div class="leaderboard-section">
    <div class="section-header">
      <div class="section-title">Classement</div>
      <div class="section-mono">classement collectif ¬∑ en direct</div>
    </div>
    <div class="filter-tabs">
      <button class="tab-btn active" onclick="showRanking('preferred', this)">Les plus accept√©es</button>
      <button class="tab-btn" onclick="showRanking('refused', this)">Les plus refus√©es</button>
      <button class="tab-btn" onclick="showRanking('contested', this)">Les plus contest√©es</button>
    </div>
    <div class="leaderboard" id="leaderboard">
      <div class="no-votes">Votez pour voir le classement appara√Ætre‚Ä¶</div>
    </div>
  </div>
</div>

<footer>
  Les √©missions sont des estimations moyennes. Sources : ADEME, Our World in Data, IEA.<br>
  <em>50 ‚Äì 500 kg de CO‚ÇÇ</em> ‚âà dilemmes calibr√©s ADEME, empreinte annuelle FR ‚âà 10 t.
  <div class="db-status" id="db-status">
    <div class="live-dot" id="live-dot"></div>
    <span id="db-status-text">Connexion √† la base de donn√©es‚Ä¶</span>
  </div>
</footer>

<script type="module">
import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js';
import { getFirestore, collection, doc, setDoc, increment, onSnapshot, writeBatch } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';

const firebaseConfig = {
  apiKey: "AIzaSyBjBb9ta2_fkgmc40mbQZlMiWjuBdE5rM4",
  authDomain: "survey2-5d3a9.firebaseapp.com",
  projectId: "survey2-5d3a9",
  storageBucket: "survey2-5d3a9.firebasestorage.app",
  messagingSenderId: "1039782419824",
  appId: "1:1039782419824:web:b920750541df85545c03b5"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// =============================================
// Deux jeux de propositions √† ~100 kg CO‚ÇÇ
// Sources : ADEME Base Carbone & Impact CO‚ÇÇ
//   Avion court-courrier : 0,224 kg/km
//   Voiture thermique : 0,192 kg/km
//   Voiture √©lectrique : 0,020 kg/km
//   TGV : 0,0023 kg/km
//   Bus diesel : 0,114 kg/km
//   Scooter thermique : 0,060 kg/km
//   B≈ìuf : 28,0 kg CO‚ÇÇ/kg ‚Äî Veau : 22,5
//   Crevettes : 20,3 ‚Äî Porc : 6,67 ‚Äî Poulet : 4,56
//   Fromage p√¢te dure : 6,28 ‚Äî Lait : 1,15/L
//   Smartphone : 80 ‚Äî Tablette : 87 ‚Äî √âcran : 93
//   Box internet : 81 ‚Äî PC fixe pro : 259
//   Streaming : 0,064 kg/h ‚Äî Visio : 0,057 kg/h
//   E-mail : 0,0025 kg ‚Äî √âlec. France : 0,057 kg/kWh
// =============================================
const standardProposals = [
  // --- Transport : contexte √©thique fort ---
  {text: "Prendre l'avion A/R Paris ‚Üí Marseille pour assister aux obs√®ques d'un proche", co2: 150},
  {text: "Prendre l'avion A/R Paris ‚Üí Barcelone pour un week-end de loisirs", co2: 300},
  {text: "Conduire 500 km pour rendre visite √† un parent hospitalis√©", co2: 95},
  {text: "Conduire 500 km pour un week-end gastronomique entre amis", co2: 95},
  {text: "Prendre l'avion A/R pour accompagner son enfant √† un concours national", co2: 150},
  {text: "Prendre l'avion A/R pour un enterrement de vie de c√©libataire √† Porto", co2: 400},
  {text: "Faire un A/R en voiture pour un entretien d'embauche d√©cisif (600 km)", co2: 115},
  {text: "Faire un A/R en voiture pour un concert de son artiste pr√©f√©r√© (600 km)", co2: 115},
  {text: "Se rendre au travail en voiture (20 km A/R) pendant 5 semaines ‚Äî seul emploi accessible", co2: 95},
  {text: "Se rendre √† la salle de sport en voiture (20 km A/R) pendant 5 semaines", co2: 95},
  {text: "Vol A/R Paris ‚Üí New York pour les fun√©railles d'un ami d'enfance", co2: 500},
  {text: "Vol A/R Paris ‚Üí New York pour un shopping week-end (Black Friday)", co2: 500},

  // --- Alimentation : dilemmes culturels, sant√©, plaisir ---
  {text: "Manger de la viande rouge (200 g) chaque soir pendant 3 semaines, prescrit par un m√©decin (an√©mie s√©v√®re)", co2: 115},
  {text: "Manger de la viande rouge (200 g) chaque soir pendant 3 semaines, par habitude culinaire", co2: 115},
  {text: "Consommer 5 kg de crevettes lors d'un repas de f√™te de famille traditionnel", co2: 100},
  {text: "Consommer 5 kg de crevettes en livraison √† domicile pour des ap√©ros personnels", co2: 100},
  {text: "Manger du fromage local (comt√©) 100 g/jour pendant 5 mois ‚Äî soutien aux producteurs de montagne", co2: 95},
  {text: "Manger du fromage import√© 100 g/jour pendant 5 mois ‚Äî command√© en ligne", co2: 95},
  {text: "Offrir un repas de b≈ìuf fran√ßais pour les 80 ans de sa grand-m√®re (20 convives, 10 kg)", co2: 280},
  {text: "Commander 20 burgers en livraison express pour une soir√©e foot entre copains", co2: 280},
  {text: "Boire du caf√© √©quitable 1 tasse/jour pendant 1 an (soutien coop√©rative)", co2: 60},
  {text: "Boire des capsules alu 1 tasse/jour pendant 1 an (praticit√©)", co2: 60},
  {text: "Nourrir quotidiennement une famille de 4 personnes en bio local pendant 1 mois", co2: 200},
  {text: "Commander seul en livraison express chaque soir pendant 1 mois", co2: 200},

  // --- Num√©rique : n√©cessit√© vs confort ---
  {text: "Acheter un smartphone neuf pour un adolescent entrant au lyc√©e (premier t√©l√©phone)", co2: 80},
  {text: "Acheter un smartphone neuf pour remplacer un mod√®le vieux de 2 ans encore fonctionnel", co2: 80},
  {text: "Acheter une tablette neuve pour un enfant dyslexique (outil p√©dagogique prescrit)", co2: 87},
  {text: "Acheter une tablette neuve pour regarder des s√©ries dans son lit", co2: 87},
  {text: "Acheter un PC fixe pro pour un travailleur ind√©pendant (outil principal)", co2: 260},
  {text: "Acheter un PC gamer haut de gamme pour jouer en 4K", co2: 350},
  {text: "Laisser un PC fixe (300 W) allum√© 24h/24 pendant 8 mois ‚Äî t√©l√©travail en zone rurale sans alternative", co2: 100},
  {text: "Laisser un PC fixe (300 W) allum√© 24h/24 pendant 8 mois ‚Äî miner de la cryptomonnaie", co2: 100},
  {text: "Acheter un √©cran 27\" neuf pour un graphiste freelance (outil de travail)", co2: 93},
  {text: "Acheter un √©cran 27\" neuf juste pour le gaming", co2: 93},

  // --- √ânergie & logement : vuln√©rabilit√© vs confort ---
  {text: "Chauffer un logement mal isol√© tout l'hiver pour une personne √¢g√©e seule (20 m¬≤)", co2: 100},
  {text: "Chauffer un bureau individuel tout l'hiver alors qu'un open space chauff√© est disponible", co2: 100},
  {text: "Climatiser une chambre tout l'√©t√© pour un b√©b√© en bas √¢ge", co2: 75},
  {text: "Climatiser un salon tout l'√©t√© pour son confort personnel", co2: 150},
  {text: "Faire fonctionner un chauffe-eau √©lectrique 1 an pour une famille de 3 personnes", co2: 100},
  {text: "Prendre des bains chauds quotidiens de 30 min pendant 6 mois (relaxation)", co2: 100},
  {text: "Isoler les combles d'un logement social (artisan A/R 100 km + mat√©riaux)", co2: 75},
  {text: "Faire installer un jacuzzi ext√©rieur (artisan A/R 100 km + mat√©riaux)", co2: 75},

  // --- Consommation : solidarit√© vs mode ---
  {text: "Acheter 15 t-shirts neufs en coton bio pour une association caritative (dons)", co2: 100},
  {text: "Acheter 15 t-shirts neufs en fast fashion pour renouveler sa garde-robe", co2: 100},
  {text: "Acheter un v√©lo √©lectrique neuf pour remplacer une voiture (trajet domicile‚Äìtravail)", co2: 100},
  {text: "Acheter un v√©lo √©lectrique neuf pour des promenades dominicales", co2: 100},
  {text: "Acheter un r√©frig√©rateur neuf (classe A) pour remplacer un vieux mod√®le tr√®s √©nergivore", co2: 150},
  {text: "Acheter un second r√©frig√©rateur pour stocker les boissons au garage", co2: 150},
  {text: "Acheter un canap√© neuf pour meubler un premier logement social", co2: 200},
  {text: "Acheter un canap√© design import√© pour refaire sa d√©coration int√©rieure", co2: 300},

  // --- Divers : engagement vs indiff√©rence ---
  {text: "Imprimer 10 000 pages de supports p√©dagogiques pour une √©cole sans acc√®s num√©rique", co2: 50},
  {text: "Imprimer 10 000 pages de prospectus publicitaires pour un commerce local", co2: 50},
  {text: "Consommer 2 avocats import√©s par avion/semaine pendant 1 an ‚Äî seule source de lipides (r√©gime m√©dical)", co2: 80},
  {text: "Consommer 2 avocats import√©s par avion/semaine pendant 1 an ‚Äî tendance alimentaire", co2: 80},
  {text: "A/R en voiture pour emmener un enfant handicap√© √† un centre sp√©cialis√© (400 km)", co2: 75},
  {text: "A/R en voiture pour assister √† l'ouverture d'un centre commercial (400 km)", co2: 75},

  // --- M√©ta ---
  {text: "Cr√©er ce questionnaire en discutant 2 h avec Claude Opus 4.6 (~100 requ√™tes LLM)", co2: 0.5}
];

const laboProposals = [
  // --- Missions : enjeu de carri√®re vs prestige ---
  {text: "Vol A/R pour qu'un doctorant pr√©sente sa 1 ≥·µâ publication orale en conf√©rence internationale", co2: 150},
  {text: "Vol A/R pour qu'un directeur de recherche assiste √† une conf√©rence sans pr√©sentation", co2: 150},
  {text: "Vol A/R pour un jury de th√®se (membre obligatoire, visio impossible)", co2: 150},
  {text: "Vol A/R pour un comit√© de pilotage qui pourrait se faire en visio", co2: 150},
  {text: "Vol A/R intercontinental pour qu'un post-doc donne un s√©minaire dans un labo partenaire", co2: 500},
  {text: "Vol A/R intercontinental pour un professeur invit√© √† une remise de prix honorifique", co2: 500},
  {text: "Envoyer un doctorant √† une √©cole d'√©t√© en voiture (A/R 700 km) ‚Äî formation essentielle √† sa th√®se", co2: 135},
  {text: "Envoyer un permanent √† un workshop en voiture (A/R 700 km) ‚Äî sujet p√©riph√©rique", co2: 135},
  {text: "Trajet quotidien en voiture (15 km A/R) pendant 8 semaines ‚Äî labo inaccessible en TC", co2: 70},
  {text: "Trajet quotidien en voiture (15 km A/R) pendant 8 semaines ‚Äî bus disponible (+20 min)", co2: 70},

  // --- Calcul HPC : recherche fondamentale vs optimisation ---
  {text: "Simulation CFD (10 n≈ìuds, 2 semaines) pour la th√®se d'un doctorant ‚Äî r√©sultats publiables", co2: 100},
  {text: "Simulation CFD (10 n≈ìuds, 2 semaines) pour affiner une figure avant soumission", co2: 100},
  {text: "Entra√Æner un mod√®le de deep learning (4 GPU, 6 semaines) pour un projet m√©dical", co2: 200},
  {text: "Entra√Æner un mod√®le de deep learning (4 GPU, 6 semaines) pour un benchmark d'article", co2: 200},
  {text: "Serveur de calcul 500 W en continu 5 mois ‚Äî seule ressource pour les th√©sards", co2: 100},
  {text: "Serveur de calcul 500 W en continu 5 mois ‚Äî utilis√© √† 10 % de sa capacit√©", co2: 100},
  {text: "Calcul √©l√©ments finis (20 c≈ìurs, 1 mois) pour dimensionner un prototype sismique", co2: 80},
  {text: "Calcul √©l√©ments finis (20 c≈ìurs, 1 mois) pour reproduire des r√©sultats d√©j√† publi√©s", co2: 80},
  {text: "Laisser 5 stations de travail 24h/24, 2 mois ‚Äî mesures en continu n√©cessaires", co2: 120},
  {text: "Laisser 5 stations de travail 24h/24, 2 mois ‚Äî par habitude, personne ne les √©teint", co2: 120},
  {text: "Calcul Monte-Carlo massif sur cluster pendant 1 mois ‚Äî th√®se en physique nucl√©aire", co2: 300},
  {text: "Calcul Monte-Carlo massif sur cluster pendant 1 mois ‚Äî exploration sans objectif pr√©cis", co2: 300},

  // --- √âquipement : enseignement vs recherche, n√©cessit√© vs renouvellement ---
  {text: "Acheter un oscilloscope neuf ‚Äî mod√®le en panne, TP de licence bloqu√©s", co2: 100},
  {text: "Acheter un oscilloscope neuf ‚Äî un chercheur pr√©f√®re un mod√®le plus r√©cent", co2: 100},
  {text: "Acheter une imprimante 3D pour prototyper des dispositifs m√©dicaux", co2: 80},
  {text: "Acheter une imprimante 3D pour imprimer des goodies pour les portes ouvertes", co2: 80},
  {text: "Remplacer le PC fixe d'un doctorant dont la machine plante quotidiennement", co2: 260},
  {text: "Remplacer le PC fixe d'un permanent qui veut un √©cran plus grand", co2: 260},
  {text: "Acheter 10 capteurs MEMS pour un banc de mesure ‚Äî campagne terrain unique", co2: 50},
  {text: "Acheter 10 capteurs MEMS ‚Äî exp√©rience d√©j√† r√©alis√©e dans un autre labo", co2: 50},

  // --- Consommables : exp√©riences essentielles vs confort ---
  {text: "Consommer 250 L d'azote liquide ‚Äî essais cryog√©niques sur un mat√©riau innovant", co2: 100},
  {text: "Consommer 250 L d'azote liquide ‚Äî refaire un TP d√©j√† film√© en vid√©o", co2: 100},
  {text: "Couler 750 kg de b√©ton pour √©prouvettes ‚Äî norme de certification obligatoire", co2: 100},
  {text: "Couler 750 kg de b√©ton pour √©prouvettes ‚Äî v√©rification interne non impos√©e", co2: 100},
  {text: "Utiliser 50 L de r√©sine √©poxy ‚Äî composites pour collaboration internationale", co2: 100},
  {text: "Utiliser 50 L de r√©sine √©poxy ‚Äî projet de fin d'√©tudes d'un stagiaire M1", co2: 100},
  {text: "10 bouteilles de gaz argon ‚Äî soudures sur prototype de recherche", co2: 70},
  {text: "10 bouteilles de gaz argon ‚Äî essais exploratoires sans protocole d√©fini", co2: 70},

  // --- √ânergie b√¢timent : s√©curit√© vs habitude ---
  {text: "Faire fonctionner la salle blanche 1 journ√©e ‚Äî fabriquer des micro-capteurs (projet ANR)", co2: 100},
  {text: "Faire fonctionner la salle blanche 1 journ√©e ‚Äî visite de d√©monstration pour financeurs", co2: 100},
  {text: "Hotte aspirante 24h/24, 2 mois ‚Äî manipulation de solvants toxiques obligatoire", co2: 80},
  {text: "Hotte aspirante 24h/24, 2 mois ‚Äî laiss√©e en marche par pr√©caution hors manipulation", co2: 80},
  {text: "Climatiser la salle serveur 3 semaines en √©t√© ‚Äî risque de surchauffe des machines", co2: 60},
  {text: "Climatiser un bureau individuel 3 semaines en √©t√© ‚Äî confort du chercheur", co2: 60},

  // --- Terrain : impact soci√©tal vs publication ---
  {text: "Campagne de mesures acoustiques (3 sites) ‚Äî cartographier le bruit urbain (sant√© publique)", co2: 120},
  {text: "Campagne de mesures acoustiques (3 sites) ‚Äî ajouter des donn√©es √† un article existant", co2: 120},
  {text: "Groupe √©lectrog√®ne diesel 1 semaine ‚Äî capteurs en zone isol√©e sans √©lectricit√©", co2: 100},
  {text: "Groupe √©lectrog√®ne diesel 1 semaine ‚Äî tests en ext√©rieur alors qu'un banc int√©rieur existe", co2: 100},
  {text: "Exp√©dier 200 kg de mat√©riel par fret (1 000 km) ‚Äî observatoire environnemental permanent", co2: 80},
  {text: "Exp√©dier 200 kg de mat√©riel par fret (1 000 km) ‚Äî exp√©rience ponctuelle de 2 jours", co2: 80},

  // --- Enseignement & publications ---
  {text: "500 polycopi√©s de 100 pages ‚Äî promotion sans acc√®s au num√©rique", co2: 50},
  {text: "500 polycopi√©s de 100 pages ‚Äî le PDF est disponible en ligne", co2: 50},
  {text: "√âquiper un poste √©tudiant PC neuf ‚Äî formation indispensable en simulation", co2: 260},
  {text: "√âquiper un poste √©tudiant PC neuf ‚Äî le PC actuel est lent mais fonctionnel", co2: 260},

  // --- M√©ta ---
  {text: "Cr√©er ce questionnaire labo en discutant 2 h avec Claude Opus 4.6 (~100 requ√™tes LLM)", co2: 0.5}
];

// =============================================
// Mode management: standard vs labo
// =============================================
const MODES = {
  standard: {
    coll: 'carbone_standard',
    proposals: standardProposals,
    label: '√âthique climatique ¬∑ Exp√©rience participative',
    subtitle: 'Chaque geste, chaque voyage, chaque usage num√©rique a un co√ªt climatique. Ces dilemmes vous invitent √† peser vos priorit√©s.'
  },
  labo: {
    coll: 'carbone_labo',
    proposals: laboProposals,
    label: 'Labo de recherche ¬∑ Protocole scientifique',
    subtitle: 'Version recherche : vos r√©ponses alimentent une √©tude sur la perception des arbitrages carbone. Chaque vote compte pour la science.'
  }
};

let currentAppMode = 'standard';
let proposals = MODES[currentAppMode].proposals;
let scores = proposals.map((p, i) => ({ id: i, text: p.text, co2: p.co2, wins: 0, losses: 0, elo: 1200 }));
let totalVotes = 0;
let currentA = -1;
let currentB = -1;
let currentRankMode = 'preferred';
let voted = false;
let unsubscribe = null; // Firestore listener cleanup

// --- Database status indicator ---
function setDbStatus(online) {
  const dot = document.getElementById('live-dot');
  const txt = document.getElementById('db-status-text');
  if (online) {
    dot.classList.remove('offline');
    txt.textContent = `Connect√© ¬∑ ${currentAppMode === 'labo' ? 'labo recherche' : 'standard'} ¬∑ votes en direct`;
  } else {
    dot.classList.add('offline');
    txt.textContent = 'Hors ligne ¬∑ reconnexion en cours‚Ä¶';
  }
}

// --- ELO ---
function computeElo(scores) {
  // Recompute ELO from scratch based on win/loss counts
  // Simple approximation: elo = 1200 + K * (wins - losses)
  // More accurate: use win rate adjusted
  scores.forEach(s => {
    const total = s.wins + s.losses;
    if (total === 0) { s.elo = 1200; return; }
    const winRate = s.wins / total;
    // Map win rate to ELO-like scale (logistic)
    const clampedRate = Math.max(0.01, Math.min(0.99, winRate));
    s.elo = 1200 + 400 * Math.log10(clampedRate / (1 - clampedRate)) + Math.log2(total + 1) * 5;
  });
}

// --- Real-time Firestore listener ---
function listenForUpdates() {
  if (unsubscribe) unsubscribe(); // cleanup previous listener
  const coll = MODES[currentAppMode].coll;

  unsubscribe = onSnapshot(
    collection(db, coll),
    (snapshot) => {
      setDbStatus(true);
      let totalWins = 0;
      snapshot.forEach(docSnap => {
        const idx = parseInt(docSnap.id);
        if (!isNaN(idx) && idx >= 0 && idx < proposals.length) {
          const data = docSnap.data();
          scores[idx].wins = data.wins || 0;
          scores[idx].losses = data.losses || 0;
          totalWins += (data.wins || 0);
        }
      });
      totalVotes = totalWins;
      computeElo(scores);
      document.getElementById('total-votes').textContent = totalVotes;
      renderLeaderboard();
    },
    (error) => {
      console.error('Firestore listen error:', error);
      setDbStatus(false);
    }
  );
}

// --- Mode switch ---
function switchMode(mode) {
  if (mode === currentAppMode) return;
  currentAppMode = mode;
  proposals = MODES[mode].proposals;
  scores = proposals.map((p, i) => ({ id: i, text: p.text, co2: p.co2, wins: 0, losses: 0, elo: 1200 }));
  totalVotes = 0;

  // Update UI
  document.getElementById('header-label').textContent = MODES[mode].label;
  document.getElementById('subtitle').textContent = MODES[mode].subtitle;
  document.getElementById('total-votes').textContent = '0';
  document.getElementById('leaderboard').innerHTML =
    '<div class="no-votes">Votez pour voir le classement appara√Ætre‚Ä¶</div>';

  // Update mode buttons
  document.getElementById('btn-standard').classList.toggle('active', mode === 'standard');
  document.getElementById('btn-labo').classList.toggle('active', mode === 'labo');

  // Re-listen to new Firestore collection
  listenForUpdates();
  updatePair();
}

// --- Pair management ---
function getRandomPair() {
  let a, b;
  do {
    a = Math.floor(Math.random() * proposals.length);
    b = Math.floor(Math.random() * proposals.length);
  } while (a === b);
  return [a, b];
}

function updatePair() {
  voted = false;
  const [a, b] = getRandomPair();
  currentA = a;
  currentB = b;
  document.getElementById('text-a').textContent = proposals[a].text;
  document.getElementById('text-b').textContent = proposals[b].text;
  document.getElementById('co2-a').textContent = `~${proposals[a].co2} kg CO‚ÇÇ`;
  document.getElementById('co2-b').textContent = `~${proposals[b].co2} kg CO‚ÇÇ`;
  document.getElementById('pair-label').textContent =
    `Duel #${totalVotes + 1} ‚Äî Lequel pr√©f√©reriez-vous √©mettre ?`;
  const cardA = document.getElementById('card-a');
  const cardB = document.getElementById('card-b');
  cardA.classList.remove('winner', 'loser');
  cardB.classList.remove('winner', 'loser');
  cardA.style.opacity = '';
  cardB.style.opacity = '';
}

// --- Vote (writes to Firestore) ---
async function vote(choice) {
  if (voted) return;
  voted = true;

  const winnerIdx = choice === 0 ? currentA : currentB;
  const loserIdx  = choice === 0 ? currentB : currentA;

  // Visual feedback
  const winCard  = choice === 0 ? 'card-a' : 'card-b';
  const loseCard = choice === 0 ? 'card-b' : 'card-a';
  document.getElementById(winCard).classList.add('winner');
  document.getElementById(loseCard).classList.add('loser');

  // Atomic Firestore update
  const coll = MODES[currentAppMode].coll;
  try {
    const batch = writeBatch(db);
    batch.set(doc(db, coll, String(winnerIdx)), { wins: increment(1) }, { merge: true });
    batch.set(doc(db, coll, String(loserIdx)), { losses: increment(1) }, { merge: true });
    await batch.commit();
  } catch (e) {
    console.error('Vote write error:', e);
    setDbStatus(false);
    scores[winnerIdx].wins++;
    scores[loserIdx].losses++;
    totalVotes++;
    computeElo(scores);
    document.getElementById('total-votes').textContent = totalVotes;
    renderLeaderboard();
  }

  setTimeout(updatePair, 900);
}

// --- Ranking ---
function showRanking(mode, btn) {
  currentRankMode = mode;
  document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
  if (btn) btn.classList.add('active');
  renderLeaderboard();
}

function renderLeaderboard() {
  const lb = document.getElementById('leaderboard');
  const played = scores.filter(s => s.wins + s.losses > 0);

  if (played.length === 0) {
    lb.innerHTML = '<div class="no-votes">Votez pour voir le classement appara√Ætre‚Ä¶</div>';
    return;
  }

  let sorted;
  if (currentRankMode === 'preferred') {
    sorted = [...played].sort((a, b) => b.elo - a.elo);
  } else if (currentRankMode === 'refused') {
    sorted = [...played].sort((a, b) => a.elo - b.elo);
  } else {
    sorted = [...played].sort((a, b) => {
      const tA = a.wins + a.losses, tB = b.wins + b.losses;
      const rA = tA > 0 ? Math.abs(a.wins / tA - 0.5) : 1;
      const rB = tB > 0 ? Math.abs(b.wins / tB - 0.5) : 1;
      return rA - rB || tB - tA;
    });
  }

  const maxElo = Math.max(...sorted.map(s => s.elo));
  const minElo = Math.min(...sorted.map(s => s.elo));

  lb.innerHTML = sorted.map((s, i) => {
    const total = s.wins + s.losses;
    const winRate = Math.round(s.wins / total * 100);
    const barW = maxElo === minElo ? 50 : Math.round((s.elo - minElo) / (maxElo - minElo) * 100);
    const isTop3 = i < 3;
    const isLast = i === sorted.length - 1 && sorted.length > 3;
    const medal = i === 0 ? 'ü•á' : i === 1 ? 'ü•à' : i === 2 ? 'ü•â' : `${i + 1}`;

    return `<div class="rank-item ${isTop3 ? 'top-3' : ''} ${isLast ? 'last' : ''}">
      <div class="rank-num">${medal}</div>
      <div class="rank-text">${s.text.substring(0, 85)}${s.text.length > 85 ? '‚Ä¶' : ''} <span style="color:var(--muted);font-size:0.75rem">(${s.co2} kg)</span></div>
      <div class="rank-score">ELO ${Math.round(s.elo)} ¬∑ ${winRate}% (${total}v)</div>
      <div class="rank-bar-wrap">
        <div class="rank-bar" style="width:${barW}%"></div>
      </div>
    </div>`;
  }).join('');
}

// --- Expose to window for inline onclick handlers ---
window.vote = vote;
window.nextPair = function() { updatePair(); };
window.showRanking = showRanking;
window.switchMode = switchMode;

// --- Initialize ---
updatePair();
listenForUpdates();
</script>
</body>
</html>
