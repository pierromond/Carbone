<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>‚öñÔ∏è Dilemmes Carbone</title>
<meta property="og:title" content="Dilemmes Carbone ‚Äî Quel CO‚ÇÇ choisir ?">
<meta property="og:description" content="Chaque geste a un co√ªt climatique. Votez pour hi√©rarchiser vos priorit√©s dans ces dilemmes √©thiques calibr√©s ADEME.">
<meta property="og:type" content="website">
<meta property="og:url" content="https://pierromond.github.io/Carbone/">
<meta name="description" content="Dilemmes carbone : comparez des actions du quotidien et votez. Donn√©es ADEME, votes collectifs en temps r√©el.">
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,700;0,900;1,700&family=DM+Mono:wght@400;500&family=Lora:ital@0;1&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #0e0e0b;
    --surface: #18180f;
    --card: #1e1e13;
    --border: #2e2e1e;
    --accent: #c8a84b;
    --accent2: #5d8a45;
    --text: #e8e4d4;
    --muted: #7a7660;
    --danger: #c45c3a;
    --glow: rgba(200, 168, 75, 0.15);
  }

  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'Lora', Georgia, serif;
    min-height: 100vh;
    overflow-x: hidden;
  }

  /* Grain overlay */
  body::before {
    content: '';
    position: fixed;
    inset: 0;
    background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.04'/%3E%3C/svg%3E");
    pointer-events: none;
    z-index: 1000;
    opacity: 0.5;
  }

  header {
    text-align: center;
    padding: 3rem 2rem 2rem;
    border-bottom: 1px solid var(--border);
    position: relative;
    overflow: hidden;
  }

  header::after {
    content: '';
    position: absolute;
    bottom: -1px;
    left: 50%;
    transform: translateX(-50%);
    width: 120px;
    height: 2px;
    background: var(--accent);
  }

  .header-label {
    font-family: 'DM Mono', monospace;
    font-size: 0.7rem;
    letter-spacing: 0.25em;
    text-transform: uppercase;
    color: var(--accent);
    margin-bottom: 1rem;
  }

  h1 {
    font-family: 'Playfair Display', Georgia, serif;
    font-size: clamp(2rem, 6vw, 4.5rem);
    font-weight: 900;
    line-height: 1.05;
    color: var(--text);
    margin-bottom: 0.75rem;
  }

  h1 em {
    font-style: italic;
    color: var(--accent);
  }

  .subtitle {
    font-size: 1rem;
    color: var(--muted);
    font-style: italic;
    max-width: 560px;
    margin: 0 auto;
    line-height: 1.6;
  }

  .co2-badge {
    display: inline-block;
    margin-top: 1.5rem;
    background: var(--glow);
    border: 1px solid var(--accent);
    border-radius: 2px;
    padding: 0.35rem 0.9rem;
    font-family: 'DM Mono', monospace;
    font-size: 0.75rem;
    letter-spacing: 0.1em;
    color: var(--accent);
  }

  /* Main arena */
  .arena {
    max-width: 960px;
    margin: 0 auto;
    padding: 3rem 1.5rem;
  }

  .question-label {
    font-family: 'DM Mono', monospace;
    font-size: 0.65rem;
    letter-spacing: 0.2em;
    text-transform: uppercase;
    color: var(--muted);
    text-align: center;
    margin-bottom: 2rem;
  }

  .duel {
    display: grid;
    grid-template-columns: 1fr auto 1fr;
    gap: 1.5rem;
    align-items: stretch;
    margin-bottom: 2.5rem;
  }

  .choice-card {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 4px;
    padding: 2.5rem 2rem;
    cursor: pointer;
    transition: all 0.25s ease;
    position: relative;
    overflow: hidden;
    display: flex;
    flex-direction: column;
    align-items: flex-start;
    gap: 1rem;
  }

  .choice-card::before {
    content: '';
    position: absolute;
    inset: 0;
    background: linear-gradient(135deg, var(--glow) 0%, transparent 60%);
    opacity: 0;
    transition: opacity 0.3s ease;
  }

  .choice-card:hover {
    border-color: var(--accent);
    transform: translateY(-3px);
    box-shadow: 0 12px 40px rgba(0,0,0,0.4), 0 0 0 1px var(--accent);
  }

  .choice-card:hover::before { opacity: 1; }

  .choice-card.winner {
    animation: winner-flash 0.6s ease forwards;
  }
  .choice-card.loser {
    animation: loser-fade 0.6s ease forwards;
  }

  @keyframes winner-flash {
    0% { background: var(--card); }
    40% { background: rgba(93, 138, 69, 0.3); border-color: var(--accent2); }
    100% { background: var(--card); }
  }
  @keyframes loser-fade {
    0% { opacity: 1; }
    100% { opacity: 0.3; }
  }

  .card-letter {
    font-family: 'Playfair Display', serif;
    font-size: 5rem;
    font-weight: 900;
    font-style: italic;
    color: var(--border);
    line-height: 1;
    position: absolute;
    top: 1rem;
    right: 1.5rem;
    transition: color 0.3s;
    user-select: none;
  }

  .choice-card:hover .card-letter { color: rgba(200, 168, 75, 0.2); }

  .card-tag {
    font-family: 'DM Mono', monospace;
    font-size: 0.6rem;
    letter-spacing: 0.2em;
    text-transform: uppercase;
    color: var(--accent);
    background: rgba(200, 168, 75, 0.1);
    padding: 0.2rem 0.5rem;
    border-radius: 2px;
  }

  .card-text {
    font-size: 1.1rem;
    line-height: 1.55;
    color: var(--text);
    position: relative;
    z-index: 1;
    flex: 1;
  }

  .card-co2 {
    font-family: 'DM Mono', monospace;
    font-size: 0.75rem;
    color: var(--muted);
    display: flex;
    align-items: center;
    gap: 0.4rem;
  }

  .card-co2 span {
    color: var(--accent);
    font-weight: 500;
  }

  .card-co2.co2-high span { color: var(--danger); }
  .card-co2.co2-low span { color: var(--accent2); }

  .vs-divider {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    padding: 0 0.5rem;
  }

  .vs-line {
    width: 1px;
    flex: 1;
    background: var(--border);
  }

  .vs-text {
    font-family: 'Playfair Display', serif;
    font-size: 1.4rem;
    font-style: italic;
    color: var(--muted);
    writing-mode: vertical-rl;
    letter-spacing: 0.1em;
  }

  .vote-counter {
    text-align: center;
    font-family: 'DM Mono', monospace;
    font-size: 0.7rem;
    color: var(--muted);
    letter-spacing: 0.1em;
  }

  .vote-counter strong {
    color: var(--accent);
    font-size: 1.1rem;
  }

  .skip-btn {
    display: block;
    margin: 0 auto 3rem;
    background: none;
    border: 1px solid var(--border);
    color: var(--muted);
    font-family: 'DM Mono', monospace;
    font-size: 0.7rem;
    letter-spacing: 0.15em;
    text-transform: uppercase;
    padding: 0.5rem 1.5rem;
    cursor: pointer;
    border-radius: 2px;
    transition: all 0.2s ease;
  }

  .skip-btn:hover { color: var(--text); border-color: var(--muted); }

  /* Leaderboard */
  .leaderboard-section {
    border-top: 1px solid var(--border);
    padding-top: 3rem;
  }

  .section-header {
    display: flex;
    align-items: baseline;
    gap: 1rem;
    margin-bottom: 2rem;
  }

  .section-title {
    font-family: 'Playfair Display', serif;
    font-size: 1.8rem;
    font-weight: 700;
    font-style: italic;
  }

  .section-mono {
    font-family: 'DM Mono', monospace;
    font-size: 0.65rem;
    letter-spacing: 0.2em;
    text-transform: uppercase;
    color: var(--muted);
  }

  .leaderboard {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }

  .rank-item {
    display: grid;
    grid-template-columns: 3rem 1fr auto auto;
    align-items: center;
    gap: 1rem;
    padding: 0.9rem 1rem;
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 3px;
    transition: all 0.4s ease;
    position: relative;
    overflow: hidden;
  }

  .rank-item.top-3 {
    border-color: rgba(200, 168, 75, 0.4);
  }

  .rank-item.top-3::before {
    content: '';
    position: absolute;
    left: 0;
    top: 0;
    bottom: 0;
    width: 3px;
    background: var(--accent);
  }

  .rank-num {
    font-family: 'DM Mono', monospace;
    font-size: 0.8rem;
    color: var(--muted);
    text-align: center;
  }

  .rank-item.top-3 .rank-num {
    color: var(--accent);
    font-weight: 500;
  }

  .rank-text {
    font-size: 0.9rem;
    line-height: 1.4;
    color: var(--text);
  }

  .rank-score {
    font-family: 'DM Mono', monospace;
    font-size: 0.75rem;
    color: var(--accent2);
    white-space: nowrap;
  }

  .rank-bar-wrap {
    width: 80px;
    height: 4px;
    background: var(--border);
    border-radius: 2px;
    overflow: hidden;
  }

  .rank-bar {
    height: 100%;
    background: var(--accent);
    border-radius: 2px;
    transition: width 0.6s ease;
  }

  .rank-item.last .rank-bar {
    background: var(--danger);
  }

  .no-votes {
    color: var(--muted);
    font-style: italic;
    font-size: 0.85rem;
  }

  .filter-tabs {
    display: flex;
    gap: 0.5rem;
    margin-bottom: 1.5rem;
    flex-wrap: wrap;
  }

  .tab-btn {
    font-family: 'DM Mono', monospace;
    font-size: 0.65rem;
    letter-spacing: 0.15em;
    text-transform: uppercase;
    padding: 0.35rem 0.9rem;
    border: 1px solid var(--border);
    background: none;
    color: var(--muted);
    border-radius: 2px;
    cursor: pointer;
    transition: all 0.2s;
  }

  .tab-btn.active, .tab-btn:hover {
    background: var(--glow);
    border-color: var(--accent);
    color: var(--accent);
  }

  footer {
    text-align: center;
    padding: 3rem 2rem;
    border-top: 1px solid var(--border);
    margin-top: 4rem;
    font-family: 'DM Mono', monospace;
    font-size: 0.65rem;
    letter-spacing: 0.1em;
    color: var(--muted);
  }

  footer em { color: var(--accent); }

  @media (max-width: 640px) {
    .duel {
      grid-template-columns: 1fr;
      grid-template-rows: 1fr auto 1fr;
    }
    .vs-divider { flex-direction: row; padding: 0; }
    .vs-line { flex: 1; height: 1px; width: auto; }
    .vs-text { writing-mode: horizontal-tb; }
    .rank-bar-wrap { display: none; }
    .rank-item { grid-template-columns: 2.5rem 1fr auto; }
  }

  .db-status {
    display: inline-flex;
    align-items: center;
    gap: 0.4rem;
    margin-top: 0.75rem;
  }

  .live-dot {
    width: 6px;
    height: 6px;
    background: var(--accent2);
    border-radius: 50%;
    animation: pulse-live 2s infinite;
  }

  .live-dot.offline {
    background: var(--danger);
    animation: none;
  }

  @keyframes pulse-live {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.3; }
  }

  /* Mode switcher */
  .mode-switcher {
    position: fixed;
    top: 1rem;
    left: 1rem;
    z-index: 999;
    display: flex;
    flex-direction: column;
    gap: 0.35rem;
  }

  .mode-btn {
    font-family: 'DM Mono', monospace;
    font-size: 0.6rem;
    letter-spacing: 0.1em;
    text-transform: uppercase;
    padding: 0.4rem 0.75rem;
    border: 1px solid var(--border);
    background: var(--surface);
    color: var(--muted);
    border-radius: 3px;
    cursor: pointer;
    transition: all 0.25s ease;
    white-space: nowrap;
    text-align: left;
  }

  .mode-btn:hover {
    border-color: var(--muted);
    color: var(--text);
  }

  .mode-btn.active {
    background: var(--glow);
    border-color: var(--accent);
    color: var(--accent);
    box-shadow: 0 0 12px rgba(200, 168, 75, 0.15);
  }

  .mode-btn .mode-icon {
    margin-right: 0.3rem;
  }

  .mode-indicator {
    font-family: 'DM Mono', monospace;
    font-size: 0.55rem;
    letter-spacing: 0.15em;
    text-transform: uppercase;
    color: var(--muted);
    padding: 0 0.2rem;
  }

  @media (max-width: 640px) {
    .mode-switcher {
      position: relative;
      top: auto;
      left: auto;
      flex-direction: row;
      justify-content: center;
      padding: 0.75rem 1rem 0;
    }
  }

  /* Duel transition */
  #duel {
    transition: opacity 0.3s ease, transform 0.3s ease;
  }
  #duel.transitioning {
    opacity: 0;
    transform: scale(0.97);
  }

  /* Post-vote info */
  .post-vote-info {
    text-align: center;
    margin: 1rem 0 0.5rem;
    min-height: 2.5rem;
  }
  .equiv-bubble {
    font-family: 'DM Mono', monospace;
    font-size: 0.7rem;
    color: var(--accent);
    opacity: 0;
    transition: opacity 0.4s ease;
    padding: 0.3rem 0.8rem;
    display: inline-block;
    letter-spacing: 0.05em;
  }
  .equiv-bubble.visible { opacity: 1; }
  .streak-msg {
    font-family: 'DM Mono', monospace;
    font-size: 0.7rem;
    color: var(--accent2);
    opacity: 0;
    transition: opacity 0.4s ease;
    margin-top: 0.3rem;
  }
  .streak-msg.visible { opacity: 1; }
</style>
</head>
<body>

<div class="mode-switcher" id="mode-switcher">
  <div class="mode-indicator">mode</div>
  <button class="mode-btn active" id="btn-standard" onclick="switchMode('standard')">
    <span class="mode-icon">üéØ</span>Standard
  </button>
  <button class="mode-btn" id="btn-labo" onclick="switchMode('labo')">
    <span class="mode-icon">üî¨</span>Labo recherche
  </button>
</div>

<header>
  <div class="header-label" id="header-label">√âthique climatique ¬∑ Exp√©rience participative</div>
  <h1>Quel <em>CO‚ÇÇ</em><br>choisir ?</h1>
  <p class="subtitle" id="subtitle">Chaque geste, chaque voyage, chaque usage num√©rique a un co√ªt climatique. Ces dilemmes vous invitent √† peser vos priorit√©s.</p>
  <div class="co2-badge">‚âà 50 √† 500 kg CO‚ÇÇ √©quivalent par option</div>
</header>

<div class="arena">
  <div class="question-label" id="pair-label">Duel #1 ‚Äî Lequel pr√©f√©reriez-vous √©mettre ?</div>

  <div class="duel" id="duel">
    <div class="choice-card" id="card-a" onclick="vote(0)" role="button" tabindex="0">
      <div class="card-letter">A</div>
      <div class="card-tag">Option A</div>
      <div class="card-text" id="text-a">‚Ä¶</div>
      <div class="card-co2" id="co2-wrap-a">üåø <span id="co2-a">~100 kg CO‚ÇÇ</span></div>
    </div>
    <div class="vs-divider">
      <div class="vs-line"></div>
      <div class="vs-text">ou</div>
      <div class="vs-line"></div>
    </div>
    <div class="choice-card" id="card-b" onclick="vote(1)" role="button" tabindex="0">
      <div class="card-letter">B</div>
      <div class="card-tag">Option B</div>
      <div class="card-text" id="text-b">‚Ä¶</div>
      <div class="card-co2" id="co2-wrap-b">üåø <span id="co2-b">~100 kg CO‚ÇÇ</span></div>
    </div>
  </div>

  <div class="post-vote-info" id="post-vote-info">
    <div class="equiv-bubble" id="equiv-bubble"></div>
    <div class="streak-msg" id="streak-msg"></div>
  </div>

  <div class="vote-counter">
    <strong id="total-votes">0</strong> votes collectifs enregistr√©s
  </div>

  <button class="skip-btn" onclick="nextPair()">Passer ce duel ‚Üí</button>

  <!-- Leaderboard -->
  <div class="leaderboard-section">
    <div class="section-header">
      <div class="section-title">Classement</div>
      <div class="section-mono">classement collectif ¬∑ en direct</div>
    </div>
    <div class="filter-tabs">
      <button class="tab-btn active" onclick="showRanking('preferred', this)">Les plus accept√©es</button>
      <button class="tab-btn" onclick="showRanking('refused', this)">Les plus refus√©es</button>
      <button class="tab-btn" onclick="showRanking('contested', this)">Les plus contest√©es</button>
    </div>
    <div class="leaderboard" id="leaderboard">
      <div class="no-votes">Votez pour voir le classement appara√Ætre‚Ä¶</div>
    </div>
  </div>
</div>

<footer>
  Les √©missions sont des estimations moyennes. Sources : ADEME, Our World in Data, IEA.<br>
  <em>50 ‚Äì 500 kg de CO‚ÇÇ</em> ‚âà dilemmes calibr√©s ADEME, empreinte annuelle FR ‚âà 10 t.
  <div class="db-status" id="db-status">
    <div class="live-dot" id="live-dot"></div>
    <span id="db-status-text">Connexion √† la base de donn√©es‚Ä¶</span>
  </div>
</footer>

<script type="module">
import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js';
import { getFirestore, collection, doc, setDoc, increment, onSnapshot, writeBatch } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';
import { standardProposals } from './proposals-standard.js';
import { laboProposals } from './proposals-labo.js';

const firebaseConfig = {
  apiKey: "AIzaSyBjBb9ta2_fkgmc40mbQZlMiWjuBdE5rM4",
  authDomain: "survey2-5d3a9.firebaseapp.com",
  projectId: "survey2-5d3a9",
  storageBucket: "survey2-5d3a9.firebasestorage.app",
  messagingSenderId: "1039782419824",
  appId: "1:1039782419824:web:b920750541df85545c03b5"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// =============================================
// Mode management: standard vs labo
// =============================================
const MODES = {
  standard: {
    coll: 'carbone_standard',
    proposals: standardProposals,
    label: '√âthique climatique ¬∑ Exp√©rience participative',
    subtitle: 'Chaque geste, chaque voyage, chaque usage num√©rique a un co√ªt climatique. Ces dilemmes vous invitent √† peser vos priorit√©s.'
  },
  labo: {
    coll: 'carbone_labo',
    proposals: laboProposals,
    label: 'Labo de recherche ¬∑ Protocole scientifique',
    subtitle: 'Version recherche : vos r√©ponses alimentent une √©tude sur la perception des arbitrages carbone. Chaque vote compte pour la science.'
  }
};

let currentAppMode = 'standard';
let proposals = MODES[currentAppMode].proposals;
// Build a map id‚Üíscore for Firestore lookup
let scores = proposals.map(p => ({ id: p.id, text: p.text, co2: p.co2, wins: 0, losses: 0, elo: 1200 }));
let scoreById = Object.fromEntries(scores.map(s => [s.id, s]));
let totalVotes = 0;
let currentA = -1;
let currentB = -1;
let currentRankMode = 'preferred';
let voted = false;
let localDuelCount = 0;
let unsubscribe = null; // Firestore listener cleanup

// --- Database status indicator ---
function setDbStatus(online, detail) {
  const dot = document.getElementById('live-dot');
  const txt = document.getElementById('db-status-text');
  if (online) {
    dot.classList.remove('offline');
    txt.textContent = `Connect√© ¬∑ ${currentAppMode === 'labo' ? 'labo recherche' : 'standard'} ¬∑ votes en direct`;
  } else {
    dot.classList.add('offline');
    txt.textContent = detail || 'Hors ligne ¬∑ reconnexion en cours‚Ä¶';
  }
}

// --- ELO ---
function computeElo(scores) {
  // Recompute ELO from scratch based on win/loss counts
  // Simple approximation: elo = 1200 + K * (wins - losses)
  // More accurate: use win rate adjusted
  scores.forEach(s => {
    const total = s.wins + s.losses;
    if (total === 0) { s.elo = 1200; return; }
    const winRate = s.wins / total;
    // Map win rate to ELO-like scale (logistic)
    const clampedRate = Math.max(0.01, Math.min(0.99, winRate));
    s.elo = 1200 + 400 * Math.log10(clampedRate / (1 - clampedRate)) + Math.log2(total + 1) * 5;
  });
}

// --- Sound & haptic ---
let audioCtx = null;
function playClick() {
  try {
    if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    if (audioCtx.state === 'suspended') audioCtx.resume();
    const osc = audioCtx.createOscillator();
    const gain = audioCtx.createGain();
    osc.connect(gain);
    gain.connect(audioCtx.destination);
    osc.frequency.value = 600;
    gain.gain.setValueAtTime(0.02, audioCtx.currentTime);
    gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.06);
    osc.start(audioCtx.currentTime);
    osc.stop(audioCtx.currentTime + 0.08);
  } catch(e) {}
}

// --- Post-vote info ---
function co2Equivalences(kg) {
  const km = Math.round(kg / 0.192);
  const pct = (kg / 10000 * 100).toFixed(1);
  return `üåç ${kg} kg CO‚ÇÇ ‚âà ${km} km en voiture ¬∑ ${pct} % empreinte annuelle FR`;
}

function showEquiv(kg) {
  const el = document.getElementById('equiv-bubble');
  el.textContent = co2Equivalences(kg);
  el.classList.add('visible');
}

function showStreak(pct) {
  const el = document.getElementById('streak-msg');
  if (pct >= 70) {
    el.textContent = `üî• ${pct} % des votants partagent votre choix !`;
  } else if (pct <= 30) {
    el.textContent = `‚ö° Choix audacieux ! Seulement ${pct} % des votants sont d'accord`;
  } else {
    el.textContent = `‚öñÔ∏è Duel serr√© ‚Äî ${pct} % des votants partagent votre choix`;
  }
  el.classList.add('visible');
}

function hidePostVote() {
  document.getElementById('equiv-bubble').classList.remove('visible');
  document.getElementById('streak-msg').classList.remove('visible');
}

// --- Real-time Firestore listener ---
function listenForUpdates() {
  if (unsubscribe) unsubscribe(); // cleanup previous listener
  const coll = MODES[currentAppMode].coll;

  unsubscribe = onSnapshot(
    collection(db, coll),
    (snapshot) => {
      setDbStatus(true);
      let totalWins = 0;
      snapshot.forEach(docSnap => {
        const docId = docSnap.id;
        if (scoreById[docId]) {
          const data = docSnap.data();
          scoreById[docId].wins = data.wins || 0;
          scoreById[docId].losses = data.losses || 0;
          totalWins += (data.wins || 0);
        }
      });
      totalVotes = totalWins;
      computeElo(scores);
      document.getElementById('total-votes').textContent = totalVotes;
      renderLeaderboard();
    },
    (error) => {
      console.error('Firestore listen error:', error);
      if (error.code === 'permission-denied') {
        setDbStatus(false, '‚ö†Ô∏è R√®gles Firestore expir√©es ‚Äî mettez √† jour les r√®gles dans la console Firebase');
      } else {
        setDbStatus(false, 'Hors ligne ¬∑ reconnexion en cours‚Ä¶');
      }
    }
  );
}

// --- Mode switch ---
function switchMode(mode) {
  if (mode === currentAppMode) return;
  currentAppMode = mode;
  proposals = MODES[mode].proposals;
  scores = proposals.map(p => ({ id: p.id, text: p.text, co2: p.co2, wins: 0, losses: 0, elo: 1200 }));
  scoreById = Object.fromEntries(scores.map(s => [s.id, s]));
  totalVotes = 0;

  // Update UI
  document.getElementById('header-label').textContent = MODES[mode].label;
  document.getElementById('subtitle').textContent = MODES[mode].subtitle;
  document.getElementById('total-votes').textContent = '0';
  document.getElementById('leaderboard').innerHTML =
    '<div class="no-votes">Votez pour voir le classement appara√Ætre‚Ä¶</div>';

  // Update mode buttons
  document.getElementById('btn-standard').classList.toggle('active', mode === 'standard');
  document.getElementById('btn-labo').classList.toggle('active', mode === 'labo');

  // Re-listen to new Firestore collection
  listenForUpdates();
  updatePair();
}

// --- Pair management ---
function getRandomPair() {
  if (proposals.length < 2) return [0, 0];
  // 10 % : paire th√©matique (propositions cons√©cutives)
  // 90 % : duel al√©atoire
  const maxPairIdx = Math.floor(proposals.length / 2);
  if (Math.random() < 0.1 && maxPairIdx > 0) {
    const p = Math.floor(Math.random() * maxPairIdx);
    return [p * 2, p * 2 + 1];
  }
  let a, b;
  do {
    a = Math.floor(Math.random() * proposals.length);
    b = Math.floor(Math.random() * proposals.length);
  } while (a === b);
  return [a, b];
}

function updatePair() {
  voted = false;
  localDuelCount++;
  hidePostVote();
  const [a, b] = getRandomPair();
  currentA = a;
  currentB = b;
  document.getElementById('text-a').textContent = proposals[a].text;
  document.getElementById('text-b').textContent = proposals[b].text;
  document.getElementById('co2-a').textContent = `~${proposals[a].co2} kg CO‚ÇÇ`;
  document.getElementById('co2-b').textContent = `~${proposals[b].co2} kg CO‚ÇÇ`;
  // Rep√®re visuel CO‚ÇÇ : colorer si √©cart > 50 %
  const wrapA = document.getElementById('co2-wrap-a');
  const wrapB = document.getElementById('co2-wrap-b');
  wrapA.className = 'card-co2';
  wrapB.className = 'card-co2';
  const coA = proposals[a].co2, coB = proposals[b].co2;
  if (coA && coB && Math.max(coA, coB) / Math.min(coA, coB) > 1.5) {
    if (coA > coB) { wrapA.classList.add('co2-high'); wrapB.classList.add('co2-low'); }
    else { wrapB.classList.add('co2-high'); wrapA.classList.add('co2-low'); }
  }
  document.getElementById('pair-label').textContent =
    `Duel #${localDuelCount} ‚Äî Lequel pr√©f√©reriez-vous √©mettre ?`;
  const cardA = document.getElementById('card-a');
  const cardB = document.getElementById('card-b');
  cardA.classList.remove('winner', 'loser');
  cardB.classList.remove('winner', 'loser');
  cardA.style.opacity = '';
  cardB.style.opacity = '';
}

// --- Vote (writes to Firestore) ---
async function vote(choice) {
  if (voted) return;
  voted = true;

  const winnerIdx = choice === 0 ? currentA : currentB;
  const loserIdx  = choice === 0 ? currentB : currentA;
  const winnerId = proposals[winnerIdx].id;
  const loserId  = proposals[loserIdx].id;

  // Sound + haptic
  playClick();
  if (navigator.vibrate) navigator.vibrate(30);

  // Visual feedback
  const winCard  = choice === 0 ? 'card-a' : 'card-b';
  const loseCard = choice === 0 ? 'card-b' : 'card-a';
  document.getElementById(winCard).classList.add('winner');
  document.getElementById(loseCard).classList.add('loser');

  // Equivalence p√©dagogique
  showEquiv(proposals[winnerIdx].co2);

  // Streak ‚Äî montre le % d'accord si assez de donn√©es
  const ws = scoreById[winnerId];
  const wTotal = ws.wins + ws.losses;
  if (wTotal >= 3) {
    showStreak(Math.round(ws.wins / wTotal * 100));
  }

  // Transition fluide vers le prochain duel (lanc√©e imm√©diatement, ind√©pendante du r√©seau)
  const duel = document.getElementById('duel');
  setTimeout(() => {
    duel.classList.add('transitioning');
    setTimeout(() => {
      updatePair();
      duel.classList.remove('transitioning');
    }, 300);
  }, 900);

  // Atomic Firestore update (en parall√®le de la transition)
  const coll = MODES[currentAppMode].coll;
  try {
    const batch = writeBatch(db);
    batch.set(doc(db, coll, winnerId), { wins: increment(1) }, { merge: true });
    batch.set(doc(db, coll, loserId), { losses: increment(1) }, { merge: true });
    await batch.commit();
  } catch (e) {
    console.error('Vote write error:', e);
    if (e.code === 'permission-denied') {
      setDbStatus(false, '‚ö†Ô∏è R√®gles Firestore expir√©es ‚Äî mettez √† jour les r√®gles dans la console Firebase');
    } else {
      setDbStatus(false);
    }
    scoreById[winnerId].wins++;
    scoreById[loserId].losses++;
    totalVotes++;
    computeElo(scores);
    document.getElementById('total-votes').textContent = totalVotes;
    renderLeaderboard();
  }
}

// --- Ranking ---
function showRanking(mode, btn) {
  currentRankMode = mode;
  document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
  if (btn) btn.classList.add('active');
  renderLeaderboard();
}

function renderLeaderboard() {
  const lb = document.getElementById('leaderboard');
  const played = scores.filter(s => s.wins + s.losses > 0);

  if (played.length === 0) {
    lb.innerHTML = '<div class="no-votes">Votez pour voir le classement appara√Ætre‚Ä¶</div>';
    return;
  }

  let sorted;
  if (currentRankMode === 'preferred') {
    sorted = [...played].sort((a, b) => b.elo - a.elo);
  } else if (currentRankMode === 'refused') {
    sorted = [...played].sort((a, b) => a.elo - b.elo);
  } else {
    sorted = [...played].sort((a, b) => {
      const tA = a.wins + a.losses, tB = b.wins + b.losses;
      const rA = tA > 0 ? Math.abs(a.wins / tA - 0.5) : 1;
      const rB = tB > 0 ? Math.abs(b.wins / tB - 0.5) : 1;
      return rA - rB || tB - tA;
    });
  }

  const maxElo = Math.max(...sorted.map(s => s.elo));
  const minElo = Math.min(...sorted.map(s => s.elo));

  lb.innerHTML = sorted.map((s, i) => {
    const total = s.wins + s.losses;
    const winRate = Math.round(s.wins / total * 100);
    const barW = maxElo === minElo ? 50 : Math.round((s.elo - minElo) / (maxElo - minElo) * 100);
    const isTop3 = i < 3;
    const isLast = i === sorted.length - 1 && sorted.length > 3;
    const medal = i === 0 ? 'ü•á' : i === 1 ? 'ü•à' : i === 2 ? 'ü•â' : `${i + 1}`;

    return `<div class="rank-item ${isTop3 ? 'top-3' : ''} ${isLast ? 'last' : ''}">
      <div class="rank-num">${medal}</div>
      <div class="rank-text">${s.text} <span style="color:var(--muted);font-size:0.75rem">(${s.co2} kg)</span></div>
      <div class="rank-score">ELO ${Math.round(s.elo)} ¬∑ ${winRate}% (${total}v)</div>
      <div class="rank-bar-wrap">
        <div class="rank-bar" style="width:${barW}%"></div>
      </div>
    </div>`;
  }).join('');
}

// --- Expose to window for inline onclick handlers ---
window.vote = vote;
window.nextPair = function() {
  const duel = document.getElementById('duel');
  duel.classList.add('transitioning');
  setTimeout(() => {
    updatePair();
    duel.classList.remove('transitioning');
  }, 300);
};
window.showRanking = showRanking;
window.switchMode = switchMode;

// --- Keyboard accessibility ---
document.getElementById('card-a').addEventListener('keydown', e => {
  if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); vote(0); }
});
document.getElementById('card-b').addEventListener('keydown', e => {
  if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); vote(1); }
});

// --- Initialize ---
updatePair();
listenForUpdates();
</script>
</body>
</html>
